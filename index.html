
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Wern Ancheta</title>
  <meta name="author" content="Wern Ancheta">

  
  <meta name="description" content="In this post were going to explore how to do caching in PHP. But first let&rsquo;s define what caching is. With a quick Google search we get these &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://anchetaWern.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Wern Ancheta" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/javascripts/libs/fancybox/source/jquery.fancybox.css">
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Wern Ancheta</a></h1>
  
    <h2>Adventures in Web Development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:anchetaWern.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/aboutme">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/26/getting-started-with-caching-in-php/">Getting Started With Caching in PHP</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-26T09:56:00+08:00" pubdate data-updated="true">Jan 26<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/01/26/getting-started-with-caching-in-php/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post were going to explore how to do caching in PHP. But first let&rsquo;s define what caching is. With a quick Google search we get these definitions:</p>

<blockquote><p>store away in hiding or for future use.</p></blockquote>


<p>Another definition from <a href="http://www.citrix.com/glossary/caching.html">citrix.com</a></p>

<blockquote><p>Temporarily storing recently used information. The content, which includes HTML pages, images, files and Web objects, is stored on the local hard drive in order to make it faster for the user to access it, which helps improve the efficiency of the computer and its overall performance</p></blockquote>


<p>So we now know that caching is temporarily storing information in order to improve performance.</p>

<h3>Caching Techniques</h3>

<p>There are different caching methods that we can use with PHP:</p>

<ul>
<li>Caching content</li>
<li>Memory Cache</li>
<li>Database Cache</li>
<li>Opcode Cache</li>
</ul>


<h3>Caching Content</h3>

<p>We can cache content in PHP by saving the final output of a specific script into the filesystem then simply serving it like a static file for a specific period of time instead of executing the original script.</p>

<p>Below is an example on how to cache content on the FileSystem. First we declare a variable which stores the location of the cache file, current time and the time when the cache file was last modified. Once that&rsquo;s done we simply check whether there is a cache file for the particular script that a visitor is currently accessing. If there is a cache file then we simply include it in the page. If not then we access the database for the content and output the HTML. Then all of the output will be stored in the cache file. <a href="http://www.php.net/ob_start">Output buffering</a> is used to store all of the output in a string format so only the HTML that&rsquo;s outputted in the browser is going to be saved in the cache file. This means that the database access is bypassed when we load the cache file later on when a second visitor visits the site. Its like serving plain HTML, which means that it will load faster than the previous request.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$file</span> <span class="o">=</span> <span class="s1">&#39;cache/&#39;</span> <span class="o">.</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">]);</span> <span class="c1">//location of cache file</span>
</span><span class='line'><span class="nv">$current_time</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
</span><span class='line'><span class="nv">$cache_last_modified</span> <span class="o">=</span> <span class="nb">filemtime</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span> <span class="c1">//time when the cache file was last modified</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$current_time</span> <span class="o">&lt;</span> <span class="nb">strtotime</span><span class="p">(</span><span class="s1">&#39;+1 day&#39;</span><span class="p">,</span> <span class="nv">$cache_last_modified</span><span class="p">))){</span> <span class="c1">//check if cache file exists and hasn&#39;t expired yet</span>
</span><span class='line'>  <span class="k">include</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span> <span class="c1">//include cache file</span>
</span><span class='line'><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>  <span class="nb">ob_start</span><span class="p">();</span> <span class="c1">//start output buffering</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;h1&gt;Hello World!&lt;/h1&gt;</span>
</span><span class='line'><span class="x">  </span>
</span><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm"> some code accessing the database</span>
</span><span class='line'><span class="cm"> for some data here</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm"> probably some complex computations here</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">);</span> <span class="c1">//open cache file</span>
</span><span class='line'>  <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nb">ob_get_contents</span><span class="p">());</span> <span class="c1">//create new cache file</span>
</span><span class='line'>  <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span> <span class="c1">//close cache file</span>
</span><span class='line'>  <span class="nb">ob_end_flush</span><span class="p">();</span> <span class="c1">//flush output buffered</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h3>Opcode Cache</h3>

<p>Another method of caching is the Opcode cache or Object cache. This is mostly used for temporarily storing data and not the actual content. The first time I encountered object cache I couldn&rsquo;t understand what&rsquo;s the difference between it and sessions.
I did some reading and found out that by default sessions are stored in the filesystem. And data stored via object cache is stored in memory so its faster compared to session.</p>

<h4>APC</h4>

<p>We can implement object caching by using APC. APC isn&rsquo;t packaged with PHP so you have to install it separately. In Ubuntu you can install it by going to the terminal and executing the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">sudo apt-get install php-apc</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once that&rsquo;s done you can simply restart Apache for the changes to reflect.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">sudo service apache2 restart</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using APC is simple. There are only 3 methods that you need to remember in order to start using it:</p>

<ul>
<li><strong>apc_add/apc_store</strong> &ndash; store a variable in the cache. The only difference between <code>apc_add</code> and <code>apc_store</code> is that <code>apc_store</code> overwrites the data if it already exists and <code>apc_add</code> does not</li>
<li><strong>apc_fetch</strong> &ndash; fetch a variable from the cache</li>
<li><strong>apc_delete</strong> &ndash; delete a variable from the cache</li>
</ul>


<p>Below is a sample implementation of APC. Here were simply checking if the value returned from fetching the <code>db_results</code> cache is null. If its null then we get the data from the database, store the results in the cache then do something with the results that were retrieved. If the call to <code>apc_fetch</code> returned something then we simply use it instead of travelling back to the database to get the data that we need.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$results_array</span> <span class="o">=</span> <span class="nb">apc_fetch</span><span class="p">(</span><span class="s1">&#39;db_results&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$results_array</span> <span class="o">==</span> <span class="k">null</span><span class="p">){</span>
</span><span class='line'>  <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mysqli</span><span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="nv">$database</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">//get data from the database</span>
</span><span class='line'>  <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT title, SUM(views) AS view_count FROM tbl_octoblog </span>
</span><span class='line'><span class="s2">     LEFT JOIN tbl_blogviews ON tbl_octoblog.id = tbl_blogviews.post_id</span>
</span><span class='line'><span class="s2">     GROUP BY title&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$results_array</span> <span class="o">=</span> <span class="nv">$results</span><span class="o">-&gt;</span><span class="na">fetch_array</span><span class="p">(</span><span class="nx">MYSQLI_ASSOC</span><span class="p">);</span> <span class="c1">//convert results to associative array</span>
</span><span class='line'>  <span class="nb">apc_add</span><span class="p">(</span><span class="s1">&#39;db_results&#39;</span><span class="p">,</span> <span class="nv">$results_array</span><span class="p">,</span> <span class="mi">86400</span><span class="p">);</span> <span class="c1">//store results in the cache for 1 day (1 day = 86400 seconds)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//do something with the $results_array</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>If you wish to learn more about APC, be sure to check out the <a href="http://www.php.net/apc/">official APC documentation</a> on PHP.net.</p>

<h4>Memcached</h4>

<p>Memcached is an in-memory key-value store for small chunks of arbitrary data (strings, objects) from results of database calls, API calls, or page rendering. That&rsquo;s the definition that I got from the memcached site. To put simply, memcached is used for temporarily storing data that came from a specific source (database, API, page rendering).</p>

<p>To install memcached execute the following from your terminal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">sudo apt-get install memcached</span>
</span></code></pre></td></tr></table></div></figure>


<p>And just like with APC, you also have to restart apache in order for the changes to take effect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">sudo service apache2 restart</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once that&rsquo;s done, you can go ahead and start using memcached. To use memcached you first have to define the memcached server in which you want to connect to. Since this is just a getting started tutorial we can simply use <code>127.0.0.1</code> as the host. This refers to the localhost or the machine that you&rsquo;re currently working on. As for the port, the default port that memcached is running on is port <code>11211</code>. You can change these values by updating the <code>memcached.conf</code> file located under the <code>etc</code> directory.
After that, declare a new object of the Memcache class then call the <code>connect</code> method using the newly declared object. The <code>connect</code> method takes up the host and port that you declared earlier as its arguments. You can then use the variable that you used to store the result of that call to check whether the connection was successful or not.
From there the scenario is similar to that of the APC example earlier. First you call the <code>get</code> method and supply a unique key that you will be using to refer to the data as the argument then store the result in a variable. Then you simply check whether this variable contains <code>null</code>. If its <code>null</code> then it means there&rsquo;s no data assigned to the specific key that you used so you have to get the data from its original source, in the case of the example below the database is the original source. Once you get the data from its original source you can then use the <code>set</code> method to save the data into the cache. The <code>set</code> method takes up 2 required arguments, the first is the unique key that will be used to identify the data, the second is the data that you want to store, the third is a flag on whether to use compression or not. If you want to compress the data you can use <code>MEMCACHE_COMPRESSED</code> as the value for the flag, otherwise simply use <code>false</code>. The last argument is the expiration time. You can use either a unix timestamp or the number of seconds in which to store the data in the cache. In the example below we used the number of seconds <code>86400</code> which is the number of seconds in a day.
The next time the script runs it will no longer go back to the database to get the data. It will get it from the cache instead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="c1">//define the memcached host and port to connect to</span>
</span><span class='line'><span class="nv">$memcache_host</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$memcache_port</span> <span class="o">=</span> <span class="s1">&#39;11211&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//connect to memcached server</span>
</span><span class='line'><span class="nv">$memcache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Memcache</span><span class="p">;</span>
</span><span class='line'><span class="nv">$is_cache</span> <span class="o">=</span> <span class="nv">$memcache</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="nv">$memcache_host</span><span class="p">,</span> <span class="nv">$memcache_port</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$is_cache</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$things</span> <span class="o">=</span> <span class="nv">$memcache</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;things&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nv">$things</span> <span class="o">==</span> <span class="k">null</span><span class="p">){</span> <span class="c1">//if data hasn&#39;t been cached yet</span>
</span><span class='line'>      <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mysqli</span><span class="p">(</span><span class="nv">$db_host</span><span class="p">,</span> <span class="nv">$db_user</span><span class="p">,</span> <span class="nv">$db_password</span><span class="p">,</span> <span class="nv">$db_name</span><span class="p">);</span>
</span><span class='line'>      <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM tbl_things WHERE needed = &#39;yes&#39;&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nv">$things</span> <span class="o">=</span> <span class="nv">$results</span><span class="o">-&gt;</span><span class="na">fetch_array</span><span class="p">(</span><span class="nx">MYSQLI_ASSOC</span><span class="p">);</span> <span class="c1">//convert result set to an array</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$memcache</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;things&#39;</span><span class="p">,</span> <span class="nv">$things</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="mi">86400</span><span class="p">);</span> <span class="c1">//cache the data</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//do something with the $things, output it, mess with it, whatever.</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are some of the common methods that you can use with memcached:</p>

<ul>
<li><strong>add</strong> &ndash; saves a specific data into the cache</li>
<li><strong>store</strong> &ndash; saves a specific data into the cache. The only difference between <code>store</code> and <code>add</code> is that <code>add</code> will return <code>false</code> if the key already exists but store goes aheads and over-writes the data if it already exists</li>
<li><strong>delete</strong> &ndash; deletes data from the cache based on the key that you define as its argument</li>
<li><strong>flush</strong> &ndash; deletes all the data that you have on the cache</li>
</ul>


<p>To learn more about memcached be sure to check out the <a href="http://memcached.org/">official memcached site</a> or the <a href="http://php.net/manual/en/book.memcache.php">memcached documentation for PHP</a>.</p>

<h3>Database Cache</h3>

<p>We have been talking about how to do caching in the application layer but caching can also be in the database layer.
In this form of caching the caching is done by the database server itself. This works by caching the results of the query so the query is only parsed the first time it runs and in the succeeding requests it won&rsquo;t be parsed since the results from the specific query is already cached by the database server.
In this section I&rsquo;m going to walk you through how caching is done in MySQL.</p>

<p>To configure caching in MySQL simply open up the <code>my.cnf</code> file under the <code>etc</code> directory and add the following lines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">query_cache_type    = 1</span>
</span><span class='line'><span class="x">query_cache_limit = 1M</span>
</span><span class='line'><span class="x">query_cache_size    = 16M</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>query_cache_type</strong> &ndash; whether to enable caching. Set to <code>0</code> if you want to disable, <code>1</code> to enable for all cacheable queries except those that begin with <code>SELECT SQL_NO_CACHE</code>. And <code>2</code> to cache only for cacheable queries that begin with <code>SELECT SQL_CACHE</code></li>
<li><strong>query_cache_limit</strong> &ndash; limit caching for a specific result set. If the results returned from the query exceeds the value set in this option then it won&rsquo;t be cache</li>
<li><strong>query_cache_size</strong> &ndash; the amount of memory allocated for caching results</li>
</ul>


<p>The query cache works by storing the text of a SELECT statement together with the result. If the same query is received at a lter time, the server retrieves the results from the query cache rather than parsing and executing the statement again. The query cache is shared among sessions, so a result set generated by one client can be sent in response to the same query issued by another client.</p>

<p>But you may ask: &ldquo;What if the contents of a specific table has been changed, will the server return the results from the cache?&rdquo;. The answer is no it doesn&rsquo;t. The server is smart enough to flush the cache when the tables in question is updated or modified in some way.</p>

<p>Here are some of the things that you need to remember when using the query cache in MySQL:</p>

<ul>
<li>Only full queries are cached. This means that subqueries aren&rsquo;t cached by the server at all</li>
<li>Query cache stores the text of a SELECT statement together with the result. Yes I already said that earlier but I think its worth emphasizing</li>
<li>Only works for SELECT queries</li>
<li>No support for prepared statements</li>
<li>Only works for queries that are absolutely the same</li>
</ul>


<p>Be sure to read about <a href="http://dev.mysql.com/doc/refman/5.1/en/query-cache-operation.html">how the query caching operates</a> at the official MySQL website if you want to learn more about the query cache.</p>

<h3>Things to Remember</h3>

<p>Implementing a caching functionality in the applications that you&rsquo;re writing can be great, but like Uncle Ben from Spiderman said &lsquo;With great power comes great responsibility&rsquo;. So as developers we always have to carefully study if caching is appropriate for a specific scenario or not. For example here are some instances in which caching is not recommended:</p>

<ul>
<li>real-time data</li>
<li>search results</li>
<li>latest news</li>
</ul>


<p>A good rule of thumb when trying to implement caching is that to ask yourself whether the data needs to be always fresh or not. For the examples above caching is pretty much not applicable. But if you think about the requirements, for example for the latest news, is there always a latest news every minute? Yes there may be but does publishing a new news in news website (that&rsquo;s a tongue twister that I just came up with) takes less than a minute? Maybe you can actually apply caching but only cache for example 30 seconds. The same is true with search results, if the website doesn&rsquo;t really publish much content then caching can still be applied. Just be sure to think about the expiration time carefully.</p>

<h2>Conclusion</h2>

<p>There you have it! Some of the most common caching techniques that you can use with PHP to improve the performance of the applications that you&rsquo;re writing. Like I just said, caching is a very good way to improve the performance of your app. There&rsquo;s no need to run a query every time a page is requested. If you can cache it somewhere (filesytem, memory) will it take less time to access, the better.</p>

<h2>Resources</h2>

<ul>
<li><a href="http://stackoverflow.com/questions/548301/what-is-caching">What is Caching</a></li>
<li><a href="http://www.slideshare.net/anisniit/caching-new">Caching Basics</a></li>
<li><a href="http://www.mobify.com/blog/beginners-guide-to-http-cache-headers/">Beginners Guide to HTTP Cache Headers</a></li>
<li><a href="http://en.wikipedia.org/wiki/Database_caching">Database Caching</a></li>
<li><a href="http://www.mysqlperformanceblog.com/2011/04/04/mysql-caching-methods-and-tips/">MySQL Caching Methods Tips and Tricks</a></li>
<li><a href="http://www.taos.com/2013/04/10/understanding-mysql-query-cache/">Understanding MySQL Query Cache</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/08/getting-started-with-paypal-api/">Getting Started With Paypal API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-08T18:15:00+08:00" pubdate data-updated="true">Jan 8<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/01/08/getting-started-with-paypal-api/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial I&rsquo;m going to show you how you can get started with using the Paypal API. I&rsquo;ll walk you through the steps needed in order to get you started with using the Paypal API in your projects.</p>

<h3>Concepts to Remember</h3>

<p>Here are some of the concepts that you have to remember when working with the Paypal API in any of your projects:</p>

<ul>
<li><p><strong>Sandbox</strong> &ndash; this is used for testing requests to the Paypal API. Sandbox Paypal accounts can be assigned with funds of up to 5000 USD and then you can use it for testing.</p></li>
<li><p><strong>Live</strong> &ndash; the live Paypal website. You can switch your API calls to use the live endpoints upon deploying your project.</p></li>
<li><p><strong>API Request</strong> &ndash; you can use either NVP (Name-Value Pair) or SOAP when making request to the API. We will use name-value pairs in this tutorial.</p></li>
<li><p><strong>API Credentials</strong> &ndash; the credentials that you will use in order to make API calls.</p></li>
<li><p><strong>API</strong> &ndash; short for Application Programming Interface. Paypal is composed of different APIs such as the adaptive accounts, adaptive payments, invoicing, merchant APIs and permissions. In this tutorial I&rsquo;m going to discuss about the merchant API.</p></li>
<li><p><strong>Service Endpoint</strong> &ndash; this simply refers to the URL of the server that will handle a specific request. Note that the endpoints used for testing (sandbox) and production (live) are different. So you have to update the endpoints after you&rsquo;re done with the testing.</p></li>
<li><p><strong>Call Payload</strong> &ndash; the minimum data required by paypal that you have to submit as part of the request to the API.</p></li>
<li><p><strong>Request and Response Formats</strong> &ndash; the format in which your API request and the response that&rsquo;s going to be returned after a successful call.</p></li>
<li><p><strong>HTTP Headers</strong> &ndash; the HTTP request header information that you have to specify in each API call.</p></li>
</ul>


<h3>Create a Paypal Account</h3>

<p>First you have to create either a Paypal Personal Account or a Paypal Business Account on the Paypal website.
After creating an account go to <a href="https://developer.paypal.com/">developer.paypal.com</a> and login using the account that you created.</p>

<h3>Create a Sandbox Account</h3>

<p>Once you&rsquo;re logged in to the paypal developer website, click on the applications tab then go to sandbox accounts. In this page you will see the default paypal account that you can use for testing. The default account contains information that you can use to authenticate your API calls. In most cases you would only need to take note of the username, password and the signature in order to authenticate API calls.</p>

<p><img src="/images/posts/getting_started_with_paypal/default-test-account.png" alt="default account" /></p>

<p>The default test account is a business account so if you need to test on a personal account you may need to create a new test account which you can do on the same page by clicking on the <code>Create Account</code> button.</p>

<p><img src="/images/posts/getting_started_with_paypal/paypal-create-testacc.png" alt="create test account" /></p>

<p>The default test account along with any test account that you create can be used to login in the <a href="https://www.sandbox.paypal.com">sandbox paypal website</a>. This is great as you can use this like a real paypal account to view your transactions, make payments, etc.</p>

<h3>Getting Live API Credentials</h3>

<p>Note that the API credentials that comes along with the default test account can&rsquo;t be used to make API calls with the live version of the API. For that you would need to login to <a href="http://paypal.com">paypal</a> then go to <strong>My Account</strong> &ndash;> <strong>Profile</strong> &ndash;> <strong>My Selling Tools</strong> then click on the <strong>update</strong> link beside the <strong>API Access</strong> section. After that click on the <strong>Request API Credentials</strong> link. Finally, select <strong>Request API signature</strong> and click <strong>Agree and Submit</strong>. This will generate the API Username, Password and Signature that you can use in your live API calls.</p>

<h3>Paypal Class</h3>

<p>Now were ready to build the class that we will be using later on to make requests to the Paypal API.
First create a new class and call it <code>Paypal</code>. Then declare the following class variables:</p>

<ul>
<li><strong>request method</strong> &ndash; the request method to use. This can be either CURL or file_get_contents.</li>
<li><strong>errors</strong> &ndash; stores the current errors that occured while making the requests.</li>
<li><strong>credentials</strong> &ndash; stores the API credentials.</li>
<li><strong>endpoint</strong> &ndash; the URL of the service end point to use.</li>
<li><strong>version</strong> &ndash; the version of the API. Currently its 74.0</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Paypal</span><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nv">$request_method</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nv">$_errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">protected</span> <span class="nv">$_credentials</span><span class="p">;</span>
</span><span class='line'>  <span class="k">protected</span> <span class="nv">$_endPoint</span> <span class="o">=</span> <span class="s1">&#39;https://api-3t.sandbox.paypal.com/nvp&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">protected</span> <span class="nv">$_version</span> <span class="o">=</span> <span class="s1">&#39;74.0&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Next declare the constructor. This will take 3 required arguments and two optional arguments:</p>

<ul>
<li><p><strong>user</strong> &ndash; the API username that you got from paypal. Note that this should correspond with the endpoint that you use. If the endpoint is a sandbox endpoint then use the sandbox credentials otherwise use the live credentials.</p></li>
<li><p><strong>pass</strong> &ndash; the API password</p></li>
<li><strong>signature</strong> &ndash; the API signature</li>
<li><strong>paypal server</strong> &ndash; this can either be set to sandbox or live. This is set to sandbox by default so its using the sandbox endpoint. Setting this to live will set the endpoint to the live endpoint.</li>
<li><strong>request method</strong> &ndash; the request method to use, this can be either file_get_contents or curl. Its recommended to use curl since its more secure. The file_get_contents method is only there in case the server where you are deploying has no support for CURL.</li>
</ul>


<p>What the constructor does is to initialize the values for the class variables based on the arguments supplied when an object for the class is declared.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">,</span> <span class="nv">$signature</span><span class="p">,</span> <span class="nv">$paypal_server</span> <span class="o">=</span> <span class="s1">&#39;sandbox&#39;</span><span class="p">,</span> <span class="nv">$request_method</span> <span class="o">=</span> <span class="s1">&#39;file_get_contents&#39;</span><span class="p">){</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_credentials</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;USER&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;PWD&#39;</span> <span class="o">=&gt;</span> <span class="nv">$pass</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;SIGNATURE&#39;</span> <span class="o">=&gt;</span> <span class="nv">$signature</span><span class="p">,</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request_method</span> <span class="o">=</span> <span class="nv">$request_method</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$paypal_server</span> <span class="o">==</span> <span class="s1">&#39;live&#39;</span><span class="p">){</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_endPoint</span> <span class="o">=</span> <span class="s1">&#39;https://api-3t.paypal.com/nvp&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Next create the request method. This will be the primary method that we will call from this class once we make the request to the API. This accepts two arguments:</p>

<ul>
<li><strong>method</strong> &ndash; the API method to use.</li>
<li><strong>params</strong> &ndash; the parameters required by the method that we specified.</li>
</ul>


<p>What this method does is to build the name-value pair that will be used for the request. It also builds the required HTTP header based on the credentials supplied through the constructor earlier. Once its done building all the information required by a specific API method it makes the request depending on the request method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">request</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">()){</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$method</span><span class="p">)){</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;There is no API Method&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$requestParams</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>       <span class="s1">&#39;METHOD&#39;</span> <span class="o">=&gt;</span> <span class="nv">$method</span><span class="p">,</span>
</span><span class='line'>       <span class="s1">&#39;VERSION&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_version</span>
</span><span class='line'>    <span class="p">)</span> <span class="o">+</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_credentials</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$request</span> <span class="o">=</span> <span class="nb">http_build_query</span><span class="p">(</span><span class="nv">$requestParams</span> <span class="o">+</span> <span class="nv">$params</span><span class="p">);</span> <span class="c1">//build a query string based on the array of request parameters</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request_method</span> <span class="o">==</span> <span class="s1">&#39;curl&#39;</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//build the HTTP header required by Paypal</span>
</span><span class='line'>      <span class="nv">$http_header</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;X-PAYPAL-SECURITY-USERID&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_credentials</span><span class="p">[</span><span class="s1">&#39;USER&#39;</span><span class="p">],</span>
</span><span class='line'>          <span class="s1">&#39;X-PAYPAL-SECURITY-PASSWORD&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_credentials</span><span class="p">[</span><span class="s1">&#39;PWD&#39;</span><span class="p">],</span>
</span><span class='line'>          <span class="s1">&#39;X-PAYPAL-SECURITY-SIGNATURE&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_credentials</span><span class="p">[</span><span class="s1">&#39;SIGNATURE&#39;</span><span class="p">],</span>
</span><span class='line'>          <span class="s1">&#39;X-PAYPAL-REQUEST-DATA-FORMAT&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;JSON&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;X-PAYPAL-RESPONSE-DATA-FORMAT&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;JSON&#39;</span>
</span><span class='line'>      <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">//set options for CURL</span>
</span><span class='line'>      <span class="nv">$curlOptions</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span>
</span><span class='line'>          <span class="nx">CURLOPT_HTTPHEADER</span> <span class="o">=&gt;</span> <span class="nv">$http_header</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">CURLOPT_URL</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_endPoint</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">CURLOPT_VERBOSE</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">CURLOPT_SSL_VERIFYPEER</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">CURLOPT_SSL_VERIFYHOST</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">CURLOPT_CAINFO</span> <span class="o">=&gt;</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;/cert/cacert.pem&#39;</span><span class="p">,</span> <span class="c1">//CA cert file</span>
</span><span class='line'>          <span class="nx">CURLOPT_RETURNTRANSFER</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">CURLOPT_POST</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">CURLOPT_POSTFIELDS</span> <span class="o">=&gt;</span> <span class="nv">$request</span>
</span><span class='line'>      <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
</span><span class='line'>      <span class="nb">curl_setopt_array</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nv">$curlOptions</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$response</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span> <span class="c1">//make the request</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nb">curl_errno</span><span class="p">(</span><span class="nv">$ch</span><span class="p">)){</span>
</span><span class='line'>          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_errors</span> <span class="o">=</span> <span class="nb">curl_error</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span><span class='line'>          <span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>          <span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span><span class='line'>          <span class="nv">$responseArray</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>          <span class="nb">parse_str</span><span class="p">(</span><span class="nv">$response</span><span class="p">,</span> <span class="nv">$responseArray</span><span class="p">);</span> <span class="c1">//convert the response string to an array</span>
</span><span class='line'>          <span class="k">return</span> <span class="nv">$responseArray</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request_method</span> <span class="o">==</span> <span class="s1">&#39;file_get_contents&#39;</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">//build the HTTP header required by Paypal</span>
</span><span class='line'>      <span class="nv">$context_options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s2">&quot;http&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>            <span class="s2">&quot;method&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;header&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Content-type: application/x-www-form-urlencoded</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>                  <span class="s2">&quot;X-PAYPAL-SECURITY-USERID: &quot;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_credentials</span><span class="p">[</span><span class="s1">&#39;USER&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>                  <span class="s2">&quot;X-PAYPAL-SECURITY-PASSWORD: &quot;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_credentials</span><span class="p">[</span><span class="s1">&#39;PWD&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>                  <span class="s2">&quot;X-PAYPAL-SECURITY-SIGNATURE: &quot;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_credentials</span><span class="p">[</span><span class="s1">&#39;SIGNATURE&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>                  <span class="s2">&quot;X-PAYPAL-REQUEST-DATA-FORMAT: JSON</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>                  <span class="s2">&quot;X-PAYPAL-RESPONSE-DATA-FORMAT: JSON</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;content&quot;</span> <span class="o">=&gt;</span> <span class="nv">$request</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>      <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$context</span> <span class="o">=</span> <span class="nb">stream_context_create</span><span class="p">(</span><span class="nv">$context_options</span><span class="p">);</span> <span class="c1">//create context for file_get_contents</span>
</span><span class='line'>      <span class="nv">$response</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_endPoint</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span> <span class="c1">//make the request</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$responseArray</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>      <span class="nb">parse_str</span><span class="p">(</span><span class="nv">$response</span><span class="p">,</span> <span class="nv">$responseArray</span><span class="p">);</span> <span class="c1">//convert the response string to an array</span>
</span><span class='line'>      <span class="k">return</span> <span class="nv">$responseArray</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h3>API Methods</h3>

<p>Before we dive into actually making an API request its important that we first understand the API methods that we will actually use. In this tutorial were only going to use 3 methods: SetExpressCheckout, GetExpressCheckoutDetails, and DoExpressCheckoutPayment. Were going to use these methods to create an application that accepts payments using Paypal.</p>

<h4>SetExpressCheckout</h4>

<p>The <code>SetExpressCheckout</code> method allows you to initiate an express checkout transaction. This is the easiest way to implement a payment operation in your application. What this does is to generate a unique token that can be appended into the paypal URL which is used for making payments. The URL to be used for sandbox and live are different so you have to make sure that the URL that you&rsquo;re using corresponds to the current API endpoint that you&rsquo;re using:</p>

<ul>
<li><strong>sandbox</strong> &ndash; <a href="https://www.sandbox.paypal.com/webscr?cmd=_express-checkout&amp;token=UNIQUE_TOKEN">https://www.sandbox.paypal.com/webscr?cmd=_express-checkout&amp;token=UNIQUE_TOKEN</a></li>
<li><strong>live</strong> &ndash; <a href="https://www.paypal.com/webscr?cmd=_express-checkout&amp;token=UNIQUE_TOKEN">https://www.paypal.com/webscr?cmd=_express-checkout&amp;token=UNIQUE_TOKEN</a></li>
</ul>


<p>The <code>SetExpressCheckout</code> method requires the following parameters:</p>

<ul>
<li><p><strong>METHOD</strong> &ndash; must be set to <code>SetExpressCheckout</code></p></li>
<li><p><strong>RETURNURL</strong> &ndash; this is the URL where the buyer will be redirected after a successful payment</p></li>
<li><strong>CANCELURL</strong> &ndash; this is the URL where the buyer will be redirected if he doesn&rsquo;t accept to make the payment</li>
<li><strong>NOSHIPPING</strong> &ndash; you can use this to specify if shipping information is enabled or not. If the customer is paying for a specific service that doesn&rsquo;t require shipping then you can simply set the value to <code>1</code></li>
<li><p><strong>ALLOWNOTE</strong> &ndash; you can use this to specify if notes are allowed. You can set this to <code>0</code> if you don&rsquo;t want buyers to send a note along with the payment information. Otherwise set it to <code>1</code></p></li>
<li><p><strong>PAYMENTREQUEST_0_AMT</strong> &ndash; the total cost of the product or service. If you have more than one item then the value for this parameter should be the total of those items. Note that any value that you supply for any parameter that requires an amount should be expressed in 2 decimal places. So if the item is worth 25 dollars then it should be written as <code>25.00</code>.</p></li>
<li><strong>PAYMENTREQUEST_0_SHIPPINGAMT</strong> &ndash; the shipping cost. If the <code>NOSHIPPING</code> is set to <code>1</code> then there&rsquo;s no need to supply a value for this parameter</li>
<li><p><strong>PAYMENTREQUEST_0_ITEMAMT</strong> &ndash; the cost of the product or service. Note that if you have more than one product you can simply set this to <code>PAYMENTREQUEST_1_ITEMAMT</code>, <code>PAYMENTREQUEST_2_ITEMAMT</code> and so on. Just be sure to get the total of the values that you supplied to those parameters</p></li>
<li><p><strong>PAYMENTREQUEST_0_CURRENCYCODE</strong> &ndash; the currency in which the <code>PAYMENTREQUEST_0_AMT</code> and <code>PAYMENTREQUEST_0_ITEMAMT</code> is expressed. Here&rsquo;s a <a href="https://developer.paypal.com/docs/classic/api/currency_codes/">list of currency codes</a> that you can use. If you don&rsquo;t specify a value for this parameter the default value of <code>USD</code> will be used.</p></li>
<li><p><strong>L_PAYMENTREQUEST_0_NAME0</strong> &ndash; the name of the product or service</p></li>
<li><strong>L_PAYMENTREQUEST_0_DESC0</strong> &ndash; the description of the product or service</li>
<li><strong>L_PAYMENTREQUEST_0_AMT0</strong> &ndash; the cost of the product or service</li>
<li><strong>L_PAYMENTREQUEST_0_QTY0</strong> &ndash; the quantity of the product or service</li>
</ul>


<p>After a successfull request it returns the following response:</p>

<ul>
<li><strong>TOKEN</strong> &ndash; the token that can be appended to the URL of the paypal website where the payment can be made.</li>
</ul>


<h4>GetExpressCheckoutDetails</h4>

<p>The <code>GetExpressCheckoutDetails</code> method is used for getting additional information regarding a specific express checkout transaction. This is called after a payment has successfully been made through the paypal website. This happens when paypal successfully redirects to the <code>RETURNURL</code> that we specified in the <code>SetExpressCheckout</code> method.</p>

<ul>
<li><strong>TOKEN</strong> &ndash; the token that paypal has appended to the return URL. You can get the token by using <code>$_GET['token']</code>.</li>
</ul>


<p>After a successful request paypal returns a bunch of information regarding the payment. This includes information about the transaction itself and some payer information. Check out the <a href="https://developer.paypal.com/docs/classic/api/merchant/GetExpressCheckoutDetails_API_Operation_NVP/">official documentation</a> if you want to see a full list of the response objects returned from calling the <code>GetExpressCheckoutDetails</code> method.</p>

<h4>DoExpressCheckoutPayment</h4>

<p>The <code>DoExpressCheckoutPayment</code> method is used for completing the express checkout transaction. You might think that once the payment has been made its already completed but actually its not. The transaction isn&rsquo;t actually completed unless the payment is confirmed on both sides (paypal and your website).</p>

<ul>
<li><strong>TOKEN</strong> &ndash; the token that paypal has appended to the return URL. Yes this is the same as the token that you used for the <code>GetExpressCheckoutDetails</code> method.</li>
<li><strong>PAYMENTREQUEST_n_PAYMENTACTION</strong> &ndash; specifies how you want to obtain the payment. There are 3 possible values for this: <code>Authorization</code>, <code>Order</code>, and <code>Sale</code>. In most cases the value used here is <code>Sale</code>.</li>
<li><strong>PAYERID</strong> &ndash; the unique ID of the buyer. This information is also appended in the return URL, you can get it by using <code>$_GET['PayerID']</code></li>
<li><strong>PAYMENTREQUEST_0_AMT</strong> &ndash; this should be the same as the value you supplied in the <code>PAYMENTREQUEST_0_AMT</code> parameter on the <code>SetExpressCheckout</code> method.</li>
<li><strong>PAYMENTREQUEST_0_CURRENCYCODE</strong> &ndash; this should be the same as the value you supplied in the <code>PAYMENTREQUEST_0_CURRENCYCODE</code> parameter on the <code>SetExpressCheckout</code> method.</li>
</ul>


<p>After a successful request the express checkout transaction is now completed.</p>

<h3>Making API Requests</h3>

<p>Now were ready to actually make requests to the API. First include the file where the Paypal class is located. Then create a new object for the Paypal class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">require</span> <span class="s1">&#39;Paypal.php&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//get credentials from DB</span>
</span><span class='line'><span class="nv">$credentials</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s2">&quot;tbl_credentials&quot;</span><span class="p">,</span> <span class="s2">&quot;paypal&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nb">extract</span><span class="p">(</span><span class="nv">$credentials</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$paypal</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Paypal</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">,</span> <span class="nv">$signature</span><span class="p">,</span> <span class="nv">$paypal_server</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;TOKEN&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;PayerID&#39;</span><span class="p">])){</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$request_params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>     <span class="s1">&#39;RETURNURL&#39;</span> <span class="o">=&gt;</span> <span class="nv">$success_url</span><span class="p">,</span>
</span><span class='line'>     <span class="s1">&#39;CANCELURL&#39;</span> <span class="o">=&gt;</span> <span class="nv">$cancel_url</span><span class="p">,</span>
</span><span class='line'>     <span class="s1">&#39;NOSHIPPING&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
</span><span class='line'>     <span class="s1">&#39;ALLOWNOTE&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span>
</span><span class='line'>  <span class="p">);</span>   
</span><span class='line'>
</span><span class='line'>  <span class="nv">$order_params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>     <span class="s1">&#39;PAYMENTREQUEST_0_AMT&#39;</span> <span class="o">=&gt;</span> <span class="nv">$amount</span><span class="p">,</span>
</span><span class='line'>     <span class="s1">&#39;PAYMENTREQUEST_0_ITEMAMT&#39;</span> <span class="o">=&gt;</span> <span class="nv">$amount</span><span class="p">,</span>
</span><span class='line'>     <span class="s1">&#39;PAYMENTREQUEST_0_CURRENCYCODE&#39;</span> <span class="o">=&gt;</span> <span class="nv">$currency</span>
</span><span class='line'>  <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$item</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>     <span class="s1">&#39;L_PAYMENTREQUEST_0_NAME0&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Oldies Anime Collection&#39;</span><span class="p">,</span>
</span><span class='line'>     <span class="s1">&#39;L_PAYMENTREQUEST_0_DESC0&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;old anime&#39;</span><span class="p">,</span>
</span><span class='line'>     <span class="s1">&#39;L_PAYMENTREQUEST_0_AMT0&#39;</span> <span class="o">=&gt;</span> <span class="nv">$amount</span><span class="p">,</span>
</span><span class='line'>     <span class="s1">&#39;L_PAYMENTREQUEST_0_QTY0&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span>
</span><span class='line'>  <span class="p">);</span>   
</span><span class='line'>
</span><span class='line'>  <span class="c1">//initiate express checkout transaction</span>
</span><span class='line'>  <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$paypal</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;SetExpressCheckout&#39;</span><span class="p">,</span> <span class="nv">$request_params</span> <span class="o">+</span> <span class="nv">$order_params</span> <span class="o">+</span> <span class="nv">$item</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">&#39;ACK&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Success&#39;</span><span class="p">){</span>
</span><span class='line'>      <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">&#39;TOKEN&#39;</span><span class="p">];</span>
</span><span class='line'>      <span class="c1">//redirect to paypal where the buyer will make his payment</span>
</span><span class='line'>      <span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Location: https://www.sandbox.paypal.com/webscr?cmd=_express-checkout&amp;token=&#39;</span> <span class="o">.</span> <span class="nv">$token</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>  <span class="c1">//after a successful redirect, complete the express checkout transaction</span>
</span><span class='line'>  <span class="nv">$request_params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>      <span class="s1">&#39;TOKEN&#39;</span> <span class="o">=&gt;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">],</span>
</span><span class='line'>      <span class="s1">&#39;PAYMENTACTION&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sale&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;PAYERID&#39;</span> <span class="o">=&gt;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;PayerID&#39;</span><span class="p">],</span>
</span><span class='line'>      <span class="s1">&#39;PAYMENTREQUEST_0_AMT&#39;</span> <span class="o">=&gt;</span> <span class="nv">$amount</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;PAYMENTREQUEST_0_CURRENCYCODE&#39;</span> <span class="o">=&gt;</span> <span class="nv">$currency</span>
</span><span class='line'>  <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$paypal</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;DoExpressCheckoutPayment&#39;</span><span class="p">,</span> <span class="nv">$request_params</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">&#39;ACK&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Success&#39;</span><span class="p">){</span>
</span><span class='line'>      <span class="c1">//commit the transaction in your database</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h3>Conclusion</h3>

<p>In this tutorial you&rsquo;ve learned the basics of making API requests to the Paypal API. We have specifically used the Merchant API. But there are other Paypal APIs which we can use for different use cases.</p>

<h3>Resources</h3>

<ul>
<li><a href="https://developer.paypal.com/docs/classic/api/gs_PayPalAPIs/">Paypal Classic API Getting Started Guide</a></li>
<li><a href="https://developer.paypal.com/docs/classic/api/">Paypal Classic API Reference</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/15/php-security-best-practices/">PHP Security Best Practices</a></h1>
    
    
      <p class="meta">
        








  



  
<time datetime="2013-12-15T11:00:00+08:00" pubdate data-updated="true">Dec 15<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/12/15/php-security-best-practices/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post were going to have a look at some of the best practices in PHP when it comes to security.</p>

<blockquote><p>Disclaimer: I am not a security expert. This guide is purely based on the practices that I&#8217;m currently following that I believe to be secure. I&#8217;ve done a lot of research before putting any of the information here. But if you find something that you consider to be insecure please do share in the comments.</p></blockquote>


<h3>Always Update</h3>

<p>If possible always use the latest stable release of PHP because it contains some security updates and bug fixes. This will make applications written on top of it more secure.</p>

<h3>Secure Configuration</h3>

<ul>
<li>Disable exposure of which PHP version your server is using. You can do it by searching for <code>expose_php</code> in your <code>php.ini</code> file and set it to <code>Off</code>:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>expose_php = Off </span></code></pre></td></tr></table></div></figure>


<p>This will disable the inclusion of the PHP version in the response headers under the <code>X-Powered-By</code> attribute.
Here&rsquo;s an example of a site which has set <code>expose_php</code> to <code>On</code>. As you can see the value <code>X-Powered-By</code> attribute is <code>PHP/5.4.17</code> so we pretty much know which PHP version the server is running. An attacker can use this information to exploit the security vulnerabilities of this specific PHP version.</p>

<p><img src="/images/posts/php_security_best_practices/response_headers.png" alt="response headers" /></p>

<ul>
<li><p>Make sure that you don&rsquo;t have any files in your server that calls the <code>phpinfo()</code> function. If you want to make use of it, make sure the filename can&rsquo;t easily be guessed like <code>phpinfo.php</code> and don&rsquo;t store it on the root of your web accessible directory. Don&rsquo;t forget to delete it once you&rsquo;re done.</p></li>
<li><p>Log errors instead of displaying them. Errors, notices and warnings in your web application can provide valuable information to attackers such as filenames and the name of fields that you used on your tables. Make sure you set the following in your <code>php.ini</code> file:</p></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>display_startup_errors = Off #disable displaying of startup errors
</span><span class='line'>display_errors = Off #disable displaying of errors
</span><span class='line'>html_errors = Off #disable formatting of errors in HTML
</span><span class='line'>error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT #report all errors, warnings and notices including coding standards
</span><span class='line'>log_errors = On #log errors to a file</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Disable file uploads when not needed.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>file_uploads = Off</span></code></pre></td></tr></table></div></figure>


<p>If your web application has a file upload feature then you need to make sure that you know some of the best practices in securing file uploads. Here&rsquo;s a good article from Sitepoint on <a href="http://www.sitepoint.com/file-uploads-with-php/">how to create a secure file upload in PHP</a>. You can also make use of a library that&rsquo;s specifically created for handling file uploads such as the <a href="https://packagist.org/packages/codeguy/upload">Upload library from Josh Lockhart(Codeguy)</a>.</p>

<ul>
<li>Disable remote file execution. If you don&rsquo;t need to use functions such as <code>fopen</code>, <code>fsockopen</code> or <code>file_get_contents</code> then you can just set <code>allow_url_fopen</code> to <code>Off</code>. <code>Curl</code> can provide with similar functionality so most of the time you won&rsquo;t really need it.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>allow_url_fopen = Off #disables processing of urls
</span><span class='line'>allow_url_include = Off #disable including of urls to files (e.g include 'http://iamanevilfile.php')</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Limit the maximum size of POST data to a value that you think is enough for your web application needs. This is to prevent attackers from flooding your web application by POSTing huge amounts of data. Note that this can be expressed in kilo (K), mega (M) or giga (G).</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>post_max_size = 10M</span></code></pre></td></tr></table></div></figure>


<p>Do note that the value that you set for <code>post_max_size</code> should be larger than the <code>upload_max_filesize</code> since uploaded files are also submitted via POST.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>upload_max_filesize = 5M </span></code></pre></td></tr></table></div></figure>


<p><code>memory_limit</code> should also be larger than the <code>post_max_size</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>memory_limit = 25M</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Limit maximum input time. This will limit the amount of time for PHP to parse input data from either <code>$_POST</code> or <code>$_GET</code>.
Note that the value is expressed in seconds.`</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>max_input_time = 5</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Limit maximum execution time to a reasonable value. This will automatically terminate a running PHP script once the maximum execution time is over. The default value of 30 seconds seems reasonable enough so in most cases you won&rsquo;t really need to change it.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>max_execution_time = 30</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>Limit the use of shell functions such as <code>exec</code>, <code>passthru</code>, <code>shell_exec</code>, <code>proc_open</code>, and <code>popen</code>. If there&rsquo;s no other option for implementing something and you absolutely need to use it make sure that users of your web application will not be able to execute any system commands. If you need user input for executing system commands then make sure that you&rsquo;re validating the data correctly.</p></li>
<li><p>Only allow execution of PHP files on a specific directory. Preferably this should be the web accessible root directory.</p></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>open_basedir = /var/www/public_html</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Set temporary upload directory to a path outside of the <code>open_base_dir</code>. This prevents files in the temporary upload directory from being executed.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>upload_tmp_dir = /var/www/uploads/tmp</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Make sure that your web accessible directory is set to <code>read-only</code>.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo chmod -R 0444 /var/www/public_html</span></code></pre></td></tr></table></div></figure>


<h3>Use CURL</h3>

<p>Always use the CURL extension when making requests to other servers especially if you&rsquo;re working with sensitive data.
This is because CURL by default makes requests securely over SSL/TLS (Secure Socket Layer/Transport Security Layer).
Here&rsquo;s an example on how to perform requests using CURL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$url</span> <span class="o">=</span> <span class="s1">&#39;https://bitpay.com/api/invoice&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$req</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
</span><span class='line'><span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$req</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
</span><span class='line'><span class="nv">$response</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$req</span><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Also make sure to set the following options when you&rsquo;re working with sensitive data:</p>

<ul>
<li><strong>CURLOPT_SSL_VERIFYPEER</strong> &ndash; should be set to <code>TRUE</code> always. This will tell CURL to check if the remote certificate of the server where you&rsquo;re performing a request is valid.</li>
<li><strong>CURLOPT_SSL_VERIFYHOST</strong> &ndash; should be set to <code>TRUE</code> always. This tells CURL to check that the Certificate was issued to the entity that you&rsquo;re requesting to.</li>
</ul>


<h3>Input Validation and Filtering</h3>

<p>Input validation is the first layer of defense when it comes to securing your PHP applications. User input should never be trusted thus we need to filter and validate. But first lets differentiate filtering from validation:</p>

<ul>
<li><p><strong>Filtering</strong> &ndash; also called sanitization. This is used for ensuring that the data is properly formatted before we try to validate. An example of filtering is removing whitespaces from a string or removing any invalid characters from an email address.</p></li>
<li><p><strong>Validation</strong> &ndash; the process of making sure that the data is what you expect it to be. For example if the web form asks for the age then you expect the age to be a number so the code must validate that what is inputted in the age field is indeed a number. And not just any number. If you expect the users who will fill out the form to be between ages 20 &ndash; 40 then you must also validate that the age that was inputted falls within that range. There are lots of things to consider when validating user input, as programmers its our duty to ensure that we&rsquo;ve covered most of the scenarios.</p></li>
</ul>


<h4>Filtering</h4>

<p>PHP comes with filtering functions that you can use to sanitize data before saving into the database.</p>

<ul>
<li><strong>addslashes</strong> &ndash; adds a backslash before a single quote (<code>'</code>), double quote (<code>"</code>), and NULL byte (<code>\</code>).</li>
<li><strong>filter_var</strong> &ndash; sanitizes strings based on the filters listed <a href="http://www.php.net/manual/en/filter.filters.sanitize.php">here</a></li>
<li><strong>htmlspecialchars</strong> &ndash; converts HTML strings into their corresponding entity.</li>
<li><strong>htmlentities</strong> &ndash; the same as <code>htmlspecialchars</code> the only difference is that <code>htmlentities</code> try to encode all characters which have HTML character entity equivalents. What this means is that you will have a much longer resulting string if the string that you&rsquo;re trying to use contains not only HTML but also characters which has an HTML entity equivalents.</li>
<li><strong>preg_replace</strong> &ndash; replaces all the string that matches the pattern that you specify.</li>
<li><strong>strip_tags</strong> &ndash; strips all HTML and PHP tags from the original string.</li>
<li><strong>trim</strong> &ndash; used for trimming leading and trailing whitespaces from the original string.</li>
</ul>


<p>What function you use depends on your specific needs. If you need to save a string into the database and you expect that there will be a single quote or double quote on that string then you should call <code>addslashes</code> before saving into the database. This ensures that you won&rsquo;t get any unexpected character errors when inserting the string.</p>

<h4>Validation</h4>

<p>PHP also comes with validation functions one of those is the <code>filter_var</code>. You can use it to validate different types of data:</p>

<ul>
<li><strong>FILTER_VALIDATE_BOOLEAN</strong> &ndash; used for validating if the value is either <code>true</code> or <code>false</code></li>
<li><strong>FILTER_VALIDATE_EMAIL</strong> &ndash; used for validating if the value is a valid email</li>
<li><strong>FILTER_VALIDATE_REGEXP</strong> &ndash; used for validating if the value matches a specific expression</li>
<li><strong>FILTER_VALIDATE_URL</strong> &ndash; used for validating if the value matches the accepted pattern of a URL</li>
<li><strong>FILTER_VALIDATE_INT</strong> &ndash; used for validating if the value is an integer</li>
<li><strong>FILTER_VALIDATE_FLOAT</strong> &ndash; used for validating if the value is a float or a decimal number</li>
<li><strong>FILTER_VALIDATE_IP</strong> &ndash; used for validating if the value is a valid IPv4 or IPv6 IP address</li>
</ul>


<p>Here&rsquo;s how to use the <code>filter_var</code> function to validate user input:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$email</span> <span class="o">=</span> <span class="nb">filter_var</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="nx">FILTER_VALIDATE_EMAIL</span><span class="p">);</span>
</span><span class='line'><span class="nv">$age</span> <span class="o">=</span> <span class="nb">filter_var</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="nx">FILTER_VALIDATE_INT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$email</span> <span class="o">&amp;&amp;</span> <span class="nv">$age</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$age</span> <span class="o">&gt;=</span> <span class="mi">14</span> <span class="o">&amp;&amp;</span> <span class="nv">$age</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">)){</span>
</span><span class='line'>  <span class="c1">//do something</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that the <code>filter_var</code> function returns the original value that you specified as the first argument if the value is valid and returns <code>false</code> if its not valid.</p>

<p>There are also a bunch of PHP functions that checks for a specific data type and returns <code>true</code> if the value meets</p>

<ul>
<li><strong>is_array</strong> &ndash; checks if a variable contains an array.</li>
<li><strong>is_bool</strong> &ndash; checks if a variable contains a boolean value.</li>
<li><strong>is_double</strong> &ndash; checks if a variable contains a double.</li>
<li><strong>is_float</strong> &ndash; checks if a variable contains a floating point number.</li>
<li><strong>is_integer|is_long|is_int</strong> &ndash; checks if value is a valid integer. Note that this doesn&rsquo;t check for the data type since all user input is always in string so either the value <code>'1'</code> or simply <code>1</code> will pass.</li>
<li><strong>is_null</strong> &ndash; checks if a variable is <code>NULL</code></li>
<li><strong>is_numeric</strong> &ndash; checks if a value is a valid number, the main difference of this function with <code>is_int</code> is that it also checks for the data type so string numbers such as <code>'1'</code>, <code>'23'</code>, or <code>'14'</code> will return <code>false</code>.</li>
<li><strong>is_object</strong> &ndash; checks if a variable contains an object.</li>
<li><strong>is_resource</strong> &ndash; checks if a variable contains a resource.</li>
<li><strong>is_scalar</strong> &ndash; checks if a variable contains a scalar value.</li>
<li><strong>is_string</strong> &ndash; checks if a variable contains string.</li>
</ul>


<p>And there are also those that checks for the presence of a specific value:</p>

<ul>
<li><strong>isset</strong> &ndash; checks if a specific variable has been set or declared. Note that this disregards the actual value so if the variable in question doesn&rsquo;t have a value assigned to it (aka <code>undefined</code>) then it will still return <code>true</code>.</li>
<li><strong>empty</strong> &ndash; checks if a specific variable has a truthy value. Here&rsquo;s a good reference on this subject: <a href="http://www.php.net/manual/en/types.comparisons.php">type comparisons</a></li>
</ul>


<h4>Input Filtering and Validation Libraries</h4>

<p>Here are some libraries that you can use for input validation and filtering:</p>

<ul>
<li><a href="http://documentup.com/Respect/Validation/">Respect\Validation</a></li>
<li><a href="https://github.com/ircmaxell/filterus">Filterus</a></li>
<li><a href="https://github.com/vlucas/valitron">Valitron</a></li>
<li><a href="http://htmlpurifier.org/">HTML Purifier</a></li>
</ul>


<h3>Working with Databases</h3>

<h4>Limit User Privileges</h4>

<p>When working with databases its a good practice to not use the root user as the user of the database. Sometimes out of laziness we tend to use the default database user in MySQL when connecting to the database like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mysqli</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;my_db&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>This is not a good practice since the root user has the privilege to perform almost all the operations that you can perform in all of the database that&rsquo;s currently residing in the MySQL server. Selecting data, inserting new data, updating, deleting, truncating tables, dropping tables, dropping a whole database. All of these can be performed by the root user so a successful SQL injection attack can pretty much give an attacker the privilege to do all of these operations.</p>

<p>Limiting the user privileges is really simple. In the screenshot below I&rsquo;m using a tool called phpmyadmin to create a user that has only read privileges:</p>

<p><img src="/images/posts/php_security_best_practices/mysql-privileges.png" alt="mysql read privileges" /></p>

<p>While you&rsquo;re there you can also set resource limit to the user. Setting a reasonable resource limit reduces the possibility of malicious users flooding your database with lots of queries. Just be sure to do your research first before setting resource limits to a specific database user, you don&rsquo;t want the limit to run out on genuine users of your application:</p>

<p><img src="/images/posts/php_security_best_practices/resource-limits.png" alt="limit" /></p>

<p>Limiting user privileges effectively reduces the risk of a successful SQL injection attack. It means that even if an attacker manages to execute a query like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">DROP TABLE tbl_users</span>
</span></code></pre></td></tr></table></div></figure>


<p>It won&rsquo;t be allowed by the database if the database user that was used doesn&rsquo;t have a privilege to drop a table.
But what if an attacker successfully gains access to a database user that has all the privileges to make a successful attack? For example a System Administrator user account has been hacked and now the attacker can simply use SQL injection to do all sorts of evil stuff with the database. That&rsquo;s where the use of PDO and prepared statements comes in.</p>

<h4>Use PDO Or MySQLi</h4>

<p>Use the PDO or MySqli extension when building applications that connect to the MySQL database. The original PHP MySQL API is already deprecated and therefore no longer recommended. Using PDO or MySqli will give you the benefit of using parametrized queries which effectively reduces the risk of SQL injection attacks if used correctly. Here&rsquo;s an example on how to perform database queries using PDO:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$user_id</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">is_int</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">)){</span> <span class="c1">//check if id is an integer</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">try</span><span class="p">{</span>
</span><span class='line'>      <span class="nv">$conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s2">&quot;mysql:host=localhost;dbname=my_db&quot;</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;db_user&#39;</span><span class="p">],</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;db_password&#39;</span><span class="p">]);</span>
</span><span class='line'>      <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span> <span class="c1">//tell PDO to throw exceptions  </span>
</span><span class='line'>  
</span><span class='line'>      <span class="nv">$sql</span> <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;SELECT username, role FROM tbl_users WHERE user_id = :user_id&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nv">$sql</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:user_id&#39;</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span> <span class="c1">//safely substitute the placeholder(:user_id) to the real value ($_GET[&#39;id&#39;])</span>
</span><span class='line'>      <span class="nv">$sql</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span> <span class="c1">//execute the query</span>
</span><span class='line'>  
</span><span class='line'>      <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$sql</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">();</span>
</span><span class='line'>      <span class="k">echo</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">log_exception</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span> <span class="c1">//log the exception, don&#39;t echo </span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>How does PDO make things more secure you ask? Its more secure in the sense that it sends the query and data (user input) separately to MySQL. So what happens is that the SQL string that you supplied as the argument for the <code>prepare</code> method is parsed and then later on using <code>bindParam</code> the placeholder is safely substituted to the user input. Finally the query is executed. In simple terms MySQL considers every user input as a string with no meaning when PDO is used so SQL injection is effectively prevented.</p>

<p>If you want to learn more about PDO be sure to check out the <a href="http://wiki.hashphp.org/PDO_Tutorial_for_MySQL_Developers">PDO tutorial for MySQL Developers</a></p>

<h4>Storing Passwords</h4>

<p>One more thing to consider when working with databases is how to safely store passwords. You probably already know that its a bad practice to simply store passwords in plain text. Because this means that when attackers were successfully able to dump the contents of a user table then they will basically have access to all of the users information which includes things such as credit card numbers, favorite TV show or the name of your first crush.</p>

<p>And it might already be old news to you but these functions for hashing passwords isn&rsquo;t that safe as attackers can use brute force attack or rainbow tables in order to determine a password:</p>

<ul>
<li><strong>md5</strong></li>
<li><strong>sha1</strong></li>
</ul>


<p>You can use the following functions instead:</p>

<ul>
<li><strong>hash_pbkdf2</strong></li>
<li><strong>crypt</strong></li>
<li><strong>password_hash</strong></li>
</ul>


<p>Note that some of the hashing functions like <code>hash_pbkdf2</code> and <code>password_hash</code> are only available on PHP 5.5. <code>crypt</code> is available on PHP 4 and 5.</p>

<p>Here are some examples on how to use each of the above hashing methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$password</span> <span class="o">=</span> <span class="s1">&#39;mySupeRandomPassword&#39;</span><span class="p">;</span> <span class="c1">//note: don&#39;t use a password like this</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//using hash_pbkdf2</span>
</span><span class='line'><span class="nv">$salt</span> <span class="o">=</span> <span class="nb">mcrypt_create_iv</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="nx">MCRYPT_DEV_URANDOM</span><span class="p">);</span> <span class="c1">//generate a random salt</span>
</span><span class='line'><span class="nv">$iterations</span> <span class="o">=</span> <span class="s1">&#39;1525&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$hash</span> <span class="o">=</span> <span class="nx">hash_pbkdf2</span><span class="p">(</span><span class="s2">&quot;sha256&quot;</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="nv">$salt</span><span class="p">,</span> <span class="nv">$iterations</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span> <span class="c1">//hashing algorithm, raw password, random salt, iterations, hash length</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//using crypt</span>
</span><span class='line'><span class="nv">$salt</span> <span class="o">=</span> <span class="nb">mcrypt_create_iv</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nx">MCRYPT_DEV_URANDOM</span><span class="p">);</span> <span class="c1">//generate a random salt</span>
</span><span class='line'><span class="nv">$hash</span> <span class="o">=</span> <span class="nb">crypt</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$salt</span><span class="p">);</span> <span class="c1">//raw password, random salt</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//using password_hash</span>
</span><span class='line'><span class="nv">$hash</span> <span class="o">=</span> <span class="nx">password_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nx">PASSWORD_DEFAULT</span><span class="p">);</span> <span class="c1">//PASSWORD_DEFAULT uses the Bcrypt alogrithm, you can also use PASSWORD_BCRYPT if you want to use the CRYPT_BLOWFISH algorithm for hashing the password</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>You can implement the <code>hash_pbkdf2</code> method by storing both the hash and the salt in a single field (prepend the salt to the hash).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="c1">//verifying using hash_pbkdf2</span>
</span><span class='line'><span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">get hash and salt from database</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$hash</span> <span class="o">=</span> <span class="nx">hash_pbkdf2</span><span class="p">(</span><span class="s2">&quot;sha256&quot;</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="nv">$salt_from_db</span><span class="p">,</span> <span class="nv">$iterations</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$hash_from_db</span> <span class="o">==</span> <span class="nv">$hash</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//do something</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Some people say that you should store your salt strings to a database separate from the database where you store your hashes. Maybe this is true if you don&rsquo;t use random salts for each of the passwords. An attacker would still have difficulty in cracking a password even if he has access to both salt and hash as long as the salt is random for each user.</p>

<p>For <code>crypt</code> and <code>password_hash</code> there&rsquo;s no need to store the random salts separately since you can verify if the password is valid without specifying the salt that was used:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="c1">//verifying using crypt</span>
</span><span class='line'><span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* </span>
</span><span class='line'><span class="cm">get hash from database</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">crypt</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$hash</span><span class="p">){</span> <span class="c1">//check if password is valid</span>
</span><span class='line'>  <span class="c1">//do something</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//verifying using password hash</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nx">password_verify</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">)){</span>
</span><span class='line'>  <span class="c1">//do something</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that you can also use the <code>password_verify</code> method for verifying hashes that are created by using the <code>crypt</code> method <code>password_hash</code> and <code>crypt</code> methods as they both use the <a href="http://en.wikipedia.org/wiki/Crypt_(C">C Crypt Scheme</a>).</p>

<p>You can also use password hashing libraries like <a href="https://github.com/hautelook/phpass/">PHPAss</a> or <a href="https://github.com/ircmaxell/password_compat">Password-Compat</a> if you want. The main benefit of using libraries is that they&rsquo;re often compatible with lower PHP versions but are still secure. Here&rsquo;s an example on how to use each of those:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="c1">//using password-compat</span>
</span><span class='line'><span class="k">require</span> <span class="s1">&#39;vendor/ircmaxell/password-compat/lib/password.php&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$hash</span> <span class="o">=</span> <span class="nx">password_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nx">PASSWORD_BCRYPT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//verifying</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nx">password_verify</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">)){</span>
</span><span class='line'>  <span class="c1">//do something</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="c1">//using PHPAss</span>
</span><span class='line'><span class="nv">$cost</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">//algorithmic cost that should be used, you can play around this value but this is mostly dependent on your servers hardware</span>
</span><span class='line'><span class="nv">$portable_hash</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span> <span class="c1">//do not store salts along with hash</span>
</span><span class='line'><span class="nv">$phpass</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PasswordHash</span><span class="p">(</span><span class="nv">$cost</span><span class="p">,</span> <span class="nv">$portable_hash</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$hash</span> <span class="o">=</span> <span class="nv">$phpass</span><span class="o">-&gt;</span><span class="na">HashPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//verifying</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$phpass</span><span class="o">-&gt;</span><span class="na">CheckPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">)){</span>
</span><span class='line'>  <span class="c1">//do something</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that the password-compat library uses the same syntax as the password hashing method <code>password_hash</code> in PHP 5.5. But this library works for PHP 5.3.7 and above. So this library is intended for providing forward compatibility to PHP versions lower than 5.5. This means that there&rsquo;s no real need to use this library if you&rsquo;re already using PHP 5.5.</p>

<p>Other things to remember when storing passwords:</p>

<ul>
<li>Do not email or log passwords if your users forgot their password just email them a link that will allow them to update their password.</li>
<li>Do not store passwords in plain text (yeah I know I said this already)</li>
<li>Use random password salts</li>
<li>Do not limit the length of passwords that can be entered by your users</li>
<li>Encourage your users to use long, secure and random passwords by implementing password strength meters on the front-end of your application. Passwords doesn&rsquo;t really need to be memorable as users can pretty much use password managers like <a href="http://keepass.info/">keepas</a> to store their passwords.</li>
</ul>


<h3>Working with Uploaded Files</h3>

<p>When working with uploaded files do not use the <code>$_FILE</code> super global in determining the type of the file as the can be easily spoofed by simply changing the file extension:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;jpg&#39;</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//do something with the file</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Use the <code>finfo</code> class to determine the actual mime type of a file instead. This is slower than simply checking the file type from the <code>$_FILE</code> super global but it does the job of determinining the real file type:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$file_info</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">finfo</span><span class="p">(</span><span class="nx">FILEINFO_MIME_TYPE</span><span class="p">);</span>
</span><span class='line'><span class="nv">$file_contents</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;iamnotanevilfile&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">]);</span>
</span><span class='line'><span class="nv">$mime_type</span> <span class="o">=</span> <span class="nv">$file_info</span><span class="o">-&gt;</span><span class="na">buffer</span><span class="p">(</span><span class="nv">$file_contents</span><span class="p">);</span>
</span><span class='line'><span class="c1">//this will return any valid mime type listed here: http://en.wikipedia.org/wiki/Internet_media_type</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Better yet use a library that&rsquo;s especially created for this type of task like the <a href="https://github.com/codeguy/Upload">upload library</a> by Josh Lockhart. Here&rsquo;s how you can use it to verify that the file that was uploaded is an image file that&rsquo;s not greater than 2 MB in size.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;file&quot;</span> <span class="na">name=</span><span class="s">&quot;some_file&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Upload File&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/form&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$upload_path</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Upload\Storage\FileSystem</span><span class="p">(</span><span class="s1">&#39;/upload_path&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$file</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Upload\File</span><span class="p">(</span><span class="s1">&#39;some_file&#39;</span><span class="p">,</span> <span class="nv">$upload_path</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$image_types</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;image/gif&#39;</span><span class="p">,</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;image/bmp&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">addValidations</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">\Upload\Validation\Mimetype</span><span class="p">(</span><span class="nv">$image_types</span><span class="p">),</span> <span class="c1">//can also supply a string</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">\Upload\Validation\Size</span><span class="p">(</span><span class="s1">&#39;2M&#39;</span><span class="p">)</span> <span class="c1">//size should be 2 MB or less, you can also use B, K, G as the size unit</span>
</span><span class='line'><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//try to upload the file</span>
</span><span class='line'><span class="k">try</span><span class="p">{</span>
</span><span class='line'>    <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">upload</span><span class="p">();</span> <span class="c1">//the file is uploaded if it successfully pass through the validation</span>
</span><span class='line'><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">){</span>
</span><span class='line'>    <span class="nv">$errors</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">getErrors</span><span class="p">();</span> <span class="c1">//the file upload failed</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>In this article you&rsquo;ve learned some of the basic ways you can add security to your PHP projects. We&rsquo;ve barely scratch the surface with this guide. There&rsquo;s a lot more you can do to improve the security of the applications that you&rsquo;re writing. Be sure to check out the resources below if you want to learn more about securing PHP applications.</p>

<h2>Resources</h2>

<ul>
<li><a href="https://www.owasp.org/index.php/PHP_Security_Cheat_Sheet">OWASP PHP Security Cheat Sheet</a></li>
<li><a href="http://phpsecurity.readthedocs.org/">Survive the Deep End: PHP Security</a></li>
<li><a href="http://www.php.net/manual/en/security.php">PHP.Net Security Manual</a></li>
<li><a href="http://phpsec.org/">PHP Security Guide</a></li>
<li><a href="http://www.cyberciti.biz/tips/php-security-best-practices-tutorial.html">PHP Security Best Practices for Sys Admins</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/01/getting-started-with-bitpay-api/">Getting Started With Bitpay API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-01T11:49:00+08:00" pubdate data-updated="true">Dec 1<span>st</span>, 2013</time>
        
         | <a href="/blog/2013/12/01/getting-started-with-bitpay-api/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Bitcoin is really trending these days with its value now over <a href="http://www.extremetech.com/extreme/171762-bitcoin-hits-1000-but-how-far-can-it-go">$1000 per coin</a>. I think its timely to explore some of the services which uses Bitcoin as a form of payment. Last time I also showed you how to <a href="http://anchetawern.github.io/blog/2013/11/03/gettting-started-with-coinbase-api/">get started with the Coinbase API</a> which is also another service which allows you to use Bitcoins as a means of payment for goods and services. This time we will be exploring Bitpay. But first lets determine what&rsquo;s the difference between the Coinbase and Bitpay. Here&rsquo;s a really good answer to <a href="http://bitcoin.stackexchange.com/questions/7544/what-are-the-differences-and-similarities-among-paymium-bitpay-coinbase-etc">this question</a>:</p>

<blockquote><p>BitPay is a payment processor for E-Commerce as well as for bricks and mortar / point-of-sale. This allows a business to accept bitcoins for payment and the proceeds are delivered to the merchant as directed. This could be 100% fiat (e.g., all bitcoin sales get converted to USDs immediately, or a mix, .. like 30% USD, 70% BTCs, etc.) The currently can send payments to merchants in U.S., Mexico, Canada and several nations in Europe.</p></blockquote>




<blockquote><p>Coinbase is an EWallet provider and provides a service for buying and selling bitcoins. They do not operate a market, but instead use the exchange rate from the leading exchange (Mt. Gox) for customer buying and selling. They charge just 1% to buy or sell, but they have low limits (i.e., buy a max of $100 USD per-day) for new customers still in the 30-day probationary period.</p></blockquote>


<p>So what service you use basically depends on what you need.</p>

<h3>Signing Up</h3>

<p>First you need to <a href="https://bitpay.com/start">sign up at Bitpay</a> in order to get an API key which you can use for interacting with their API. Bitpay is really strict when it comes to the registration so you really have to provide real information about your business so that you can actually confirm it when they need some confirmation.</p>

<h3>Connecting to Bitpay API</h3>

<p>The Bitpay API only requires basic HTTP authentication so the process of connecting to the API is really simple.
All you have to do is to call the <code>base64_encode()</code> method on the API key that you acquire from Bitpay and then pass it as one of the HTTP header fields. Under the <code>Authorization</code> field use <code>Basic</code> followed by the base 64 encoded string representation of the API key. Here&rsquo;s how to do it using <code>file_get_contents()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$user</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$api_key</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'><span class="nv">$context_options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s2">&quot;http&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>      <span class="s2">&quot;method&quot;</span> <span class="o">=&gt;</span> <span class="nv">$method</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;header&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Content-type: application/json</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>          <span class="s2">&quot;Content-Length: </span><span class="si">$length</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>          <span class="s2">&quot;Authorization: Basic </span><span class="si">$user</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">);</span>     
</span><span class='line'>
</span><span class='line'><span class="nv">$context</span> <span class="o">=</span> <span class="nb">stream_context_create</span><span class="p">(</span><span class="nv">$context_options</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//the $url here is the API resource that you&#39;re trying to request from</span>
</span><span class='line'><span class="nv">$response</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
</span><span class='line'><span class="nv">$response</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$response</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h3>Creating an Invoice</h3>

<p>You can create an Invoice via by using the following resource in the Bitpay API:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">https://bitpay.com/api/invoice</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then passing in all the fields required by the resource:</p>

<ul>
<li><strong>price</strong> &ndash; the price of the service or good.</li>
<li><strong>currency</strong> &ndash; any valid currency short name (USD, GBP, EUR, JPY). Here&rsquo;s a <a href="http://www.casi.org.uk/info/1051list/annexd.html">full list of valid currency short names</a>. This will be automatically converted to the corresponding value in Bitcoins (BTC) depending on the <a href="https://bitpay.com/bitcoin-exchange-rates">current Bitcoin exchange rates</a>.</li>
</ul>


<p>You can also pass in some optional fields:</p>

<ul>
<li><strong>posData</strong> &ndash; this is normally used for passing in some additional information regarding the service or good that a customer is trying to purchase</li>
<li><p><strong>notificationURL</strong> &ndash; the URL that will be pinged by Bitpay everytime the transaction status changes. Note that a change from <code>new</code> to <code>expired</code> doesn&rsquo;t count as a transaction status change. Bitpay will only ping the URL when the transaction status changes from <code>new</code> to <code>paid</code>, <code>confirmed</code>, or<code>complete</code>.</p></li>
<li><p><strong>transactionSpeed</strong> &ndash; this can be set to <code>high</code>, <code>medium</code> or <code>low</code>. High means that the invoice is considered to be confirmed after a payment has been received. Medium means it will be considered confirmed after 10 minutes. And low means it will be considered confirmed after an hour.</p></li>
<li><p><strong>fullNotifications</strong> &ndash; this can be set to <code>true</code> or <code>false</code>. If you want Bitpay to notify via email or via the notification url that you have set every time the transaction status changes then use <code>true</code>. If you only want Bitpay to notify once the transaction status becomes confirmed then set to <code>false</code>.</p></li>
<li><p><strong>notificationEmail</strong> &ndash; the email address that Bitpay will notify on every transaction status change.</p></li>
<li><strong>redirectURL</strong> &ndash; the URL in which Bitpay will display in the receipt after a payment has been made.</li>
</ul>


<p>And here are some fields which you can use to supply information regarding the product or the customer:</p>

<ul>
<li><strong>orderID</strong></li>
<li><strong>itemDesc</strong></li>
<li><strong>itemCode</strong></li>
<li><strong>physical</strong></li>
<li><strong>buyerName</strong></li>
<li><strong>buyerAddress1</strong></li>
<li><strong>buyerAddress2</strong></li>
<li><strong>buyerCity</strong></li>
<li><strong>buyerState</strong></li>
<li><strong>buyerZip</strong></li>
<li><strong>buyerCountry</strong></li>
<li><strong>buyerEmail</strong></li>
<li><strong>buyerPhone</strong></li>
</ul>


<h3>Invoice Status</h3>

<p>The invoice status is the status of the invoice at any given time. Here are some of the invoice states:</p>

<ul>
<li><strong>new</strong> &ndash; Initially the invoice status is <code>new</code>. This means that someone can still initiate a payment to the Bitcoin address that is associated with the invoice.</li>
<li><strong>paid</strong> &ndash; when an invoice becomes fully paid its status changes to <code>paid</code></li>
<li><strong>confirmed</strong> &ndash; an invoice is considered confirmed depending on the transaction speed that was set on the creation of invoice. If the transaction speed is set to low then it will be confirmed after an hour or 6 blocks in the Bitcoin network, if the transaction speed is set to medium then it will be confirmed after 1 block (10 minutes) in the Bitcoin network, if its set to high then it will be confirmed right after full payment has been made.</li>
<li><strong>complete</strong> &ndash; this means that Bitpay has credited the merchant&rsquo;s account for the invoice.</li>
<li><strong>expired</strong> &ndash; this means that no payment has been received after the 15 minute limit alloted by Bitpay.</li>
<li><strong>invalid</strong> &ndash; this means that the invoice has been paid but has not been confirmed after an hour.</li>
</ul>


<p>Now were ready to actually make a request to the Bitpay API. You can start by downloading the official <a href="https://github.com/bitpay/php-client">PHP client</a> provided by Bitpay for interacting with the Bitpay API. There&rsquo;s also a <a href="https://github.com/bitpay/ruby-client">Ruby</a> and <a href="https://github.com/bitpay/nodejs-client">Node.js</a> client if you&rsquo;re developing for those.</p>

<p>Once you&rsquo;ve downloaded it on your working directory open up the <code>bp_options.php</code> file and supply a value for the <code>apiKey</code>, <code>currency</code> or any of the optional fields that you would like to supply.</p>

<p>Create a new PHP file which we will be using to call the methods from <code>bp_lib.php</code>. To create an invoice call the <code>bpCreateInvoice()</code> method. It needs 4 arguments. The first one is the order ID which we will just supply <code>null</code> since we really don&rsquo;t have a system for generating order IDs. The second is the amount or the cost of the product or service.
The third is the optional post data in which we can provide additional information for the product or service in key-value pairs. The fourth is the additional options which is primarily used for supplying information regarding the product or the customer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">require</span> <span class="s1">&#39;bp_lib.php&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$amount</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'><span class="nv">$post_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;excalibur&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;level&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;999&#39;</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="nv">$addl_options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;itemDesc&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Anime Figurine&#39;</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$response</span> <span class="o">=</span> <span class="nx">bpCreateInvoice</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="nv">$amount</span><span class="p">,</span> <span class="nv">$post_data</span><span class="p">,</span> <span class="nv">$addl_options</span><span class="p">);</span>                   
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$response</span><span class="p">)){</span>
</span><span class='line'>  <span class="c1">//do something</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Bitpay returns a response similar to the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Array</span>
</span><span class='line'><span class="x">(</span>
</span><span class='line'><span class="x">    [id] =&gt; xxx</span>
</span><span class='line'><span class="x">    [url] =&gt; https://bitpay.com/invoice?id=xxx</span>
</span><span class='line'><span class="x">    [posData] =&gt; {&quot;posData&quot;:{&quot;name&quot;:&quot;excalibur&quot;,&quot;level&quot;:999},&quot;hash&quot;:&quot;xxxx-xx&quot;}</span>
</span><span class='line'><span class="x">    [status] =&gt; new</span>
</span><span class='line'><span class="x">    [btcPrice] =&gt; 0.0009</span>
</span><span class='line'><span class="x">    [price] =&gt; 1</span>
</span><span class='line'><span class="x">    [currency] =&gt; USD</span>
</span><span class='line'><span class="x">    [invoiceTime] =&gt; 1385885490958</span>
</span><span class='line'><span class="x">    [expirationTime] =&gt; 1385886390958</span>
</span><span class='line'><span class="x">    [currentTime] =&gt; 1385885491133</span>
</span><span class='line'><span class="x">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>id</strong> &ndash; the unique id of the invoice</li>
<li><strong>url</strong> &ndash; the URL in which the invoice can be viewed</li>
<li><strong>posData</strong> &ndash; the additional data that we provided earlier</li>
<li><strong>status</strong> &ndash; the invoice status</li>
<li><strong>btcPrice</strong> &ndash; the corresponding amount in Bitcoins of the amount supplied earlier</li>
<li><strong>price</strong> &ndash; the amount that was supplied earlier when the invoice was created</li>
<li><strong>currency</strong> &ndash; the currency of the price</li>
<li><strong>invoiceTime</strong> &ndash; the time the invoice was created since January 1, 1970 midnight. This is in a UNIX timestamp format.</li>
<li><strong>expirationTime</strong> &ndash; the time in which the invoice will expire. When the invoice expires payments can no longer be accepted.</li>
<li><strong>currentTime</strong> &ndash; the current time in the Bitpay server. This is primarily used for determining the time remaining before the invoice expires.</li>
</ul>


<p>Accessing the invoice URL will give you a page similar to the following:</p>

<p><img src="/images/posts/getting_started_with_bitpay/bitpay-donation.png" alt="invoice url" /></p>

<p>Customers can then use a Bitcoin client such as <a href="http://bitcoin.org/en/download">Bitcoin Qt</a>, <a href="http://electrum.org/">Electrum</a>, <a href="https://multibit.org/">Multibit</a>, or <a href="https://bitcoinarmory.com/">Armory</a> to pay you the merchant.</p>

<h3>Getting Invoice Status</h3>

<p>You can also get the status of an invoice by calling the <code>bpGetInvoice()</code> method and supplying the invoice ID as the argument:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$invoice</span> <span class="o">=</span> <span class="nx">bpGetInvoice</span><span class="p">(</span><span class="s1">&#39;85AHEqCRaT2aZ3xAMpK8fQ&#39;</span><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>The method will return something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Array</span>
</span><span class='line'><span class="x">(</span>
</span><span class='line'><span class="x">    [id] =&gt; xxx</span>
</span><span class='line'><span class="x">    [url] =&gt; https://bitpay.com/invoice?id=xxx</span>
</span><span class='line'><span class="x">    [posData] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [name] =&gt; excalibur</span>
</span><span class='line'><span class="x">            [age] =&gt; 27</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">    [status] =&gt; new</span>
</span><span class='line'><span class="x">    [btcPrice] =&gt; 0.0009</span>
</span><span class='line'><span class="x">    [price] =&gt; 1</span>
</span><span class='line'><span class="x">    [currency] =&gt; USD</span>
</span><span class='line'><span class="x">    [invoiceTime] =&gt; 1385885490958</span>
</span><span class='line'><span class="x">    [expirationTime] =&gt; 1385886390958</span>
</span><span class='line'><span class="x">    [currentTime] =&gt; 1385886420720</span>
</span><span class='line'><span class="x">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Its basically the same as the response that we get when creating an invoice.</p>

<h3>Bitpay Class</h3>

<p>Before I end this tutorial here&rsquo;s the modified version of the Bitpay client provided by Bitpay that works with servers without CURL support:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Bitpay</span><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="nv">$options</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$options</span><span class="p">){</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">bpLog</span><span class="p">(</span><span class="nv">$contents</span><span class="p">){</span>
</span><span class='line'>      <span class="nv">$file</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/bplog.txt&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nb">date</span><span class="p">(</span><span class="s1">&#39;m-d H:i:s&#39;</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="nx">FILE_APPEND</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$contents</span><span class="p">))</span>
</span><span class='line'>          <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">var_export</span><span class="p">(</span><span class="nv">$contents</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span> 
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">is_object</span><span class="p">(</span><span class="nv">$contents</span><span class="p">))</span>
</span><span class='line'>          <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$contents</span><span class="p">);</span>
</span><span class='line'>          
</span><span class='line'>      <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$contents</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nx">FILE_APPEND</span><span class="p">);</span>         
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">bpfilegetcontents</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$apiKey</span><span class="p">,</span> <span class="nv">$post</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">global</span> <span class="nv">$bpOptions</span><span class="p">;</span>    
</span><span class='line'>          
</span><span class='line'>      <span class="nv">$length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="nv">$method</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nv">$post</span><span class="p">){</span> 
</span><span class='line'>          <span class="nv">$length</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$post</span><span class="p">);</span>
</span><span class='line'>          <span class="nv">$method</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nv">$uname</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$apiKey</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nv">$context_options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s2">&quot;http&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>              <span class="s2">&quot;method&quot;</span> <span class="o">=&gt;</span> <span class="nv">$method</span><span class="p">,</span>
</span><span class='line'>              <span class="s2">&quot;header&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Content-type: application/json</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>                  <span class="s2">&quot;Content-Length: </span><span class="si">$length</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>                  <span class="s2">&quot;Authorization: Basic </span><span class="si">$uname</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>      <span class="p">);</span>       
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nv">$method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">){</span>
</span><span class='line'>          <span class="nv">$context_options</span><span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$post</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$context</span> <span class="o">=</span> <span class="nb">stream_context_create</span><span class="p">(</span><span class="nv">$context_options</span><span class="p">);</span>
</span><span class='line'>      <span class="nv">$response</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
</span><span class='line'>      <span class="nv">$response</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$response</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">bpCreateInvoice</span><span class="p">(</span><span class="nv">$orderId</span><span class="p">,</span> <span class="nv">$price</span><span class="p">,</span> <span class="nv">$posData</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span> 
</span><span class='line'>      
</span><span class='line'>      <span class="nv">$options</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nv">$pos</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;posData&#39;</span> <span class="o">=&gt;</span> <span class="nv">$posData</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="s1">&#39;verifyPos&#39;</span><span class="p">])</span>
</span><span class='line'>          <span class="nv">$pos</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bpHash</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$posData</span><span class="p">),</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;apiKey&#39;</span><span class="p">]);</span>
</span><span class='line'>      <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;posData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$pos</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;orderID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$orderId</span><span class="p">;</span>
</span><span class='line'>      <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$price</span><span class="p">;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nv">$postOptions</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;orderID&#39;</span><span class="p">,</span> <span class="s1">&#39;itemDesc&#39;</span><span class="p">,</span> <span class="s1">&#39;itemCode&#39;</span><span class="p">,</span> <span class="s1">&#39;notificationEmail&#39;</span><span class="p">,</span> <span class="s1">&#39;notificationURL&#39;</span><span class="p">,</span> <span class="s1">&#39;redirectURL&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;posData&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;currency&#39;</span><span class="p">,</span> <span class="s1">&#39;physical&#39;</span><span class="p">,</span> <span class="s1">&#39;fullNotifications&#39;</span><span class="p">,</span> <span class="s1">&#39;transactionSpeed&#39;</span><span class="p">,</span> <span class="s1">&#39;buyerName&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;buyerAddress1&#39;</span><span class="p">,</span> <span class="s1">&#39;buyerAddress2&#39;</span><span class="p">,</span> <span class="s1">&#39;buyerCity&#39;</span><span class="p">,</span> <span class="s1">&#39;buyerState&#39;</span><span class="p">,</span> <span class="s1">&#39;buyerZip&#39;</span><span class="p">,</span> <span class="s1">&#39;buyerEmail&#39;</span><span class="p">,</span> <span class="s1">&#39;buyerPhone&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">foreach</span><span class="p">(</span><span class="nv">$postOptions</span> <span class="k">as</span> <span class="nv">$o</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="nv">$o</span><span class="p">,</span> <span class="nv">$options</span><span class="p">))</span>
</span><span class='line'>              <span class="nv">$post</span><span class="p">[</span><span class="nv">$o</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">[</span><span class="nv">$o</span><span class="p">];</span>
</span><span class='line'>      <span class="nv">$post</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$post</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bpfilegetcontents</span><span class="p">(</span><span class="s1">&#39;https://bitpay.com/api/invoice/&#39;</span><span class="p">,</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;apiKey&#39;</span><span class="p">],</span> <span class="nv">$post</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">bpVerifyNotification</span><span class="p">(</span><span class="nv">$apiKey</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$apiKey</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">$apiKey</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="s1">&#39;apiKey&#39;</span><span class="p">];</span>      
</span><span class='line'>      
</span><span class='line'>      <span class="nv">$post</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">&quot;php://input&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$post</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span> <span class="s1">&#39;No post data&#39;</span><span class="p">;</span>
</span><span class='line'>          
</span><span class='line'>      <span class="nv">$json</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$post</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$json</span><span class="p">))</span>
</span><span class='line'>          <span class="k">return</span> <span class="nv">$json</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">&#39;posData&#39;</span><span class="p">,</span> <span class="nv">$json</span><span class="p">))</span>
</span><span class='line'>          <span class="k">return</span> <span class="s1">&#39;no posData&#39;</span><span class="p">;</span>
</span><span class='line'>          
</span><span class='line'>      <span class="nv">$posData</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">[</span><span class="s1">&#39;posData&#39;</span><span class="p">],</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="s1">&#39;verifyPos&#39;</span><span class="p">]</span> <span class="k">and</span> <span class="nv">$posData</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bpHash</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$posData</span><span class="p">[</span><span class="s1">&#39;posData&#39;</span><span class="p">]),</span> <span class="nv">$apiKey</span><span class="p">))</span>
</span><span class='line'>          <span class="k">return</span> <span class="s1">&#39;authentication failed (bad hash)&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nv">$json</span><span class="p">[</span><span class="s1">&#39;posData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$posData</span><span class="p">[</span><span class="s1">&#39;posData&#39;</span><span class="p">];</span>
</span><span class='line'>          
</span><span class='line'>      <span class="k">return</span> <span class="nv">$json</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">bpGetInvoice</span><span class="p">(</span><span class="nv">$invoiceId</span><span class="p">,</span> <span class="nv">$apiKey</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$apiKey</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">$apiKey</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">[</span><span class="s1">&#39;apiKey&#39;</span><span class="p">];</span>      
</span><span class='line'>      
</span><span class='line'>      <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bpfilegetcontents</span><span class="p">(</span><span class="s1">&#39;https://bitpay.com/api/invoice/&#39;</span><span class="o">.</span><span class="nv">$invoiceId</span><span class="p">,</span> <span class="nv">$apiKey</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$response</span><span class="p">))</span>
</span><span class='line'>          <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
</span><span class='line'>      <span class="nv">$response</span><span class="p">[</span><span class="s1">&#39;posData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">&#39;posData&#39;</span><span class="p">],</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>      <span class="nv">$response</span><span class="p">[</span><span class="s1">&#39;posData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">&#39;posData&#39;</span><span class="p">][</span><span class="s1">&#39;posData&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span> 
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">bpHash</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nv">$hmac</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">hash_hmac</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">));</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">strtr</span><span class="p">(</span><span class="nv">$hmac</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<ul>
<li><a href="https://bitpay.com/downloads/bitpayApi.pdf">Bitpay API Documentation</a></li>
<li><a href="https://github.com/bitpay/php-client">Bitpay PHP Client</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/09/getting-started-with-shopify-app-development/">Getting Started With Shopify App Development</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-09T13:34:00+08:00" pubdate data-updated="true">Nov 9<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/11/09/getting-started-with-shopify-app-development/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this article I&rsquo;ll be showing you how to start developing apps for Shopify.
But first of all what is Shopify?</p>

<blockquote><p>Shopify is an online e-commerce platform, you can use Shopify to create online stores to sell goods and services.<br/>The only difference between Shopify and other e-commerce solutions like Wordpress or Joomla is that you don&#8217;t have to install anything yourself. Every store is hosted by Shopify. But you can use a custom domain if you want.</p></blockquote>


<p>As were going to create a Shopify App its also important that we understand what a Shopify app is:</p>

<blockquote><p>Shopify apps are used for adding extra features and capabilities to Shopify.</p></blockquote>


<p>If you&rsquo;ve ever used a Content Management System like Wordpress or Drupal you might have noticed that the plugin or modules are uploaded into the site were Wordpress or Drupal is running.</p>

<p>But in Shopify you don&rsquo;t need to upload anything. Shopify apps are basically hosted on a different server. So the creators of the App takes care of all the resources needed by the app to run.</p>

<h3>Register as a Shopify Partner</h3>

<p>The first thing that you need to do is to register a Shopify Partner Account.
This will allow you to create Apps for Shopify.</p>

<p><img src="/images/posts/getting_started_with_shopify_app_development/shopify_partner_registration.png" alt="register as a shopify partner" /></p>

<p>After you have filled up and successfully submitted the form go ahead and verify your email address.</p>

<h3>Create an App</h3>

<p>Once you&rsquo;re done verifying you can now login to your Shopify partners account.</p>

<p>Once you&rsquo;re logged in click on the <code>Apps</code> tab. This is where the apps that you have created using your account will be listed.</p>

<p>Click on the <code>create app</code> button to create a new app.</p>

<p><img src="/images/posts/getting_started_with_shopify_app_development/shopify_apps.png" alt="your apps" /></p>

<p>The form for creating a new app asks for some information regarding the app that you want to create. But the only one&rsquo;s which are required is the <code>Name of app</code> and the <code>Application Callback URL</code>. As this is only a getting started tutorial were just going to fill up what&rsquo;s required. The <code>app name</code> is simply a human readable name for the app. Make sure that it directly describes what the app does so you can easily make sense of what it does by just reading its name. The <code>Application Callback URL</code> is the URL where the merchant will be redirected after he installs your app.
As we are only getting started we can actually put in the url in your local development server. So something like: <code>http://localhost/shopify_testing/shopify_app.php</code></p>

<p><img src="/images/posts/getting_started_with_shopify_app_development/create_app.png" alt="create app" /></p>

<p>Once the app is created the API Key and Shared Secret will be generated by Shopify. You can use this later on to authenticate requests to the Shopify API.</p>

<h3>Create a Dev Shop</h3>

<p>Now that you&rsquo;re done creating an App we can now create a Dev Shop. A Dev Shop as the name suggests is a Shopify Shop used for testing the apps that you develop. Unlike real Shopify Shops a Dev Shop has no time restrictions and all the functionality available to a normal Shop is also available. The only difference is that a Dev Shop cannot accept payments. Although Shopify has provided a <a href="http://docs.shopify.com/manual/your-store/orders/test-orders">bogus payment gateway</a> so developers can still test out the actual checkout process even when using a Dev Shop.</p>

<p>To create a Dev Shop, just click on the <code>Dev Shops</code> tab then click on the <code>create new dev shop</code> button.
Then fill up the form for creating a new Dev Shop. Everything is required:</p>

<p><img src="/images/posts/getting_started_with_shopify_app_development/create_devshop.png" alt="create dev shop" /></p>

<p>Once you&rsquo;re done just click on the <code>create dev shop</code> button to finish creating the dev shop.
After that you can now access your dev shop by accessing a url similar to the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://shop-name.myshopify.com/admin</span></code></pre></td></tr></table></div></figure>


<h3>Dev Shop Settings</h3>

<p>As were going to do some API calls using the app later on. Its useful to set some of the General Settings on your dev shop. I suggest supplying information for the following fields:</p>

<ul>
<li>Store name</li>
<li>Homepage title</li>
<li>Account email</li>
<li>Customer email</li>
<li>Phone</li>
<li>Street</li>
<li>City</li>
<li>Postal/Zip Code</li>
<li>Country</li>
<li>Currency</li>
</ul>


<p>You can also setup the checkout settings. Like I said earlier, a dev shop can only accept payments via the Bogus Gateway.</p>

<p><img src="/images/posts/getting_started_with_shopify_app_development/bogus_gateway.png" alt="Bogus Gateway" /></p>

<p>When testing payment via bogus gateway the credit card number will always be <code>1</code> and the card security code is <code>111</code>.</p>

<h3>Installing the Dependencies</h3>

<p>Now were ready to develop the app. To make things easier we will be using a library that will interact with the Shopify API.</p>

<p>First create a <code>composer.json</code> file and put the following contents:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>    "minimum-stability": "dev",
</span><span class='line'>    "require": {
</span><span class='line'>        "sandeepshetty/shopify_api": "dev-master"
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>If you haven&rsquo;t already installed Composer, go ahead and install it by executing the following command from the terminal:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -s http://getcomposer.org/installer | php</span></code></pre></td></tr></table></div></figure>


<p>Once Composer is installed execute the following command in the same directory where the <code>composer.json</code> file is. This will install all the Shopify API library along with all of its dependencies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>php composer.phar install</span></code></pre></td></tr></table></div></figure>


<p>Once everything is installed by Composer you will see the following directories under the <code>vendor</code> directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-composer
</span><span class='line'>-sandeepshetty
</span><span class='line'>-autoload.php</span></code></pre></td></tr></table></div></figure>


<h3>Database</h3>

<p>Were going to use the database for storing the general app data and store specific data.</p>

<h4>App Settings</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">tbl_appsettings</span><span class="o">`</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">api_key</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">redirect_url</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">permissions</span><span class="o">`</span> <span class="nb">text</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">shared_secret</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>id</strong> &ndash; auto-increment primary key</li>
<li><strong>api key</strong> &ndash; the API key that you got earlier when you created an app</li>
<li><strong>redirect_url</strong> &ndash; the url where the merchant will be redirected after installing your app. This is also the url where the merchant will be redirected when he accesses your app from his store.</li>
<li><strong>permissions</strong> &ndash; an array of permissions allowed in your app. These are specific data that your app has access to when a merchant installs your app into his Shop. Some examples are read orders and read products.</li>
<li><strong>shared_secret</strong> &ndash; your apps shared secret. This identifies you as the app owner so only you as the app creator should have access to it.</li>
</ul>


<h4>Store Settings</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">tbl_usersettings</span><span class="o">`</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">access_token</span><span class="o">`</span> <span class="nb">text</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">store_name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>id</strong> &ndash; auto-increment primary key</li>
<li><strong>access_token</strong> &ndash; the permanent access token associated with the store to be used when authenticating API requests. This is saved into the database so that there will be no need to generate the access token everytime the merchant uses the application.</li>
<li><strong>store_name</strong> &ndash; the name of the store under the myshopify domain. For example: mystore.myshopify.com</li>
</ul>


<h3>Getting App Permissions</h3>

<p>Now were ready to actually develop the app. Start by creating the file that you used earlier for the callback URL. In this case were simply going to call it <code>shopify_app.php</code>.
Include the library that we downloaded earlier using Composer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">require</span> <span class="s1">&#39;vendor/autoload.php&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">sandeepshetty\shopify_api</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Next check if the shop name is passed in the URL. When the app is accessed from the shop it will always have the shop name passed as an argument along with the callback URL that you specified in the app settings. We then use this shop name to query the database if the shop already exists.</p>

<p>If the shop already exists then we verify if the request is a valid request from Shopify. We can do that by calling the <code>is_valid_request()</code> method from the Shopify API library so were sure that not just anyone can access the app by directly inputting the URL and the required arguments.</p>

<p>If the request is valid we simply save the <code>shopify signature</code> and <code>shop name</code> to the session so it can be accessed on each subsequent request to the app. This will be used to determine if a user is currently logged in to the app.</p>

<p>This means that there&rsquo;s no need to have a separate login feature for the app. As long as the merchant has properly gone through the process of accessing the app. That is by first</p>

<p>If the shop doesn&rsquo;t exist in the database yet we simply get the specific permissions stored in the database, convert it to an array then supply it as an argument along with the shop name and api key to the <code>permission_url()</code> method. The <code>permission_url()</code> method generates the URL to the page which asks the merchant to give the app the permission to get specific data from the merchant&rsquo;s store.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nb">session_start</span><span class="p">();</span> <span class="c1">//start a session</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mysqli</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;shopify_app&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="na">connect_errno</span><span class="p">){</span>
</span><span class='line'>  <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Connect Error: &#39;</span> <span class="o">.</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">connect_errno</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$select_settings</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM tbl_appsettings WHERE id = 1&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$app_settings</span> <span class="o">=</span> <span class="nv">$select_settings</span><span class="o">-&gt;</span><span class="na">fetch_object</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;shop&#39;</span><span class="p">])){</span> <span class="c1">//check if the shop name is passed in the URL</span>
</span><span class='line'>  <span class="nv">$shop</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;shop&#39;</span><span class="p">];</span> <span class="c1">//shop-name.myshopify.com</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$select_store</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT store_name FROM tbl_usersettings WHERE store_name = &#39;</span><span class="si">$shop</span><span class="s2">&#39;&quot;</span><span class="p">);</span> <span class="c1">//check if the store exists</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nv">$select_store</span><span class="o">-&gt;</span><span class="na">num_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nx">shopify_api\is_valid_request</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">,</span> <span class="nv">$app_settings</span><span class="o">-&gt;</span><span class="na">shared_secret</span><span class="p">)){</span> <span class="c1">//check if its a valid request from Shopify        </span>
</span><span class='line'>          <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;shopify_signature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">];</span>
</span><span class='line'>          <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;shop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$shop</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Location: http://localhost/shopify_testing/admin.php&#39;</span><span class="p">);</span> <span class="c1">//redirect to the admin page</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>  <span class="p">}</span><span class="k">else</span><span class="p">{</span>     
</span><span class='line'>
</span><span class='line'>      <span class="c1">//convert the permissions to an array</span>
</span><span class='line'>      <span class="nv">$permissions</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$app_settings</span><span class="o">-&gt;</span><span class="na">permissions</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">//get the permission url</span>
</span><span class='line'>      <span class="nv">$permission_url</span> <span class="o">=</span> <span class="nx">shopify_api\permission_url</span><span class="p">(</span>
</span><span class='line'>          <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;shop&#39;</span><span class="p">],</span> <span class="nv">$app_settings</span><span class="o">-&gt;</span><span class="na">api_key</span><span class="p">,</span> <span class="nv">$permissions</span>
</span><span class='line'>      <span class="p">);</span>
</span><span class='line'>      <span class="nv">$permission_url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;redirect_uri=&#39;</span> <span class="o">.</span> <span class="nv">$app_settings</span><span class="o">-&gt;</span><span class="na">redirect_url</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Location: &#39;</span> <span class="o">.</span> <span class="nv">$permission_url</span><span class="p">);</span> <span class="c1">//redirect to the permission url</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Once the merchant has granted the permission for your app to access specific data he will be redirected to the URL you specify as the value for the <code>redirect_uri</code> argument passed in the permission URL.</p>

<p>As you can see were getting the redirect URL from the database. This redirect URL shouldn&rsquo;t necessarily be the same as the URL that you used for the callback URL in your app settings.
This redirect URL has the responsibility of saving the shop&rsquo;s details into the database. This is because the merchant will only be redirected to this URL the first time he installs your app.</p>

<p>You will know that the merchant has already been redirected to this page when both a code and the shop name is passed as an argument to the URL. A permanent access token can then be generated by passing in the name of the shop, api key, shared secret and the temporary code generated by shopify to the <code>oauth_access_token()</code> method.</p>

<p>Then we save the shop details to the database and to the current session. Finally we redirect to the admin page.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;shop&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])){</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$shop</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;shop&#39;</span><span class="p">];</span> <span class="c1">//shop name</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//get permanent access token</span>
</span><span class='line'>  <span class="nv">$access_token</span> <span class="o">=</span> <span class="nx">shopify_api\oauth_access_token</span><span class="p">(</span>
</span><span class='line'>      <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;shop&#39;</span><span class="p">],</span> <span class="nv">$app_settings</span><span class="o">-&gt;</span><span class="na">api_key</span><span class="p">,</span> <span class="nv">$app_settings</span><span class="o">-&gt;</span><span class="na">shared_secret</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//save the shop details to the database</span>
</span><span class='line'>  <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;</span>
</span><span class='line'><span class="s2">     INSERT INTO tbl_usersettings </span>
</span><span class='line'><span class="s2">     SET access_token = &#39;</span><span class="si">$access_token</span><span class="s2">&#39;,</span>
</span><span class='line'><span class="s2">     store_name = &#39;</span><span class="si">$shop</span><span class="s2">&#39;</span>
</span><span class='line'><span class="s2"> &quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//save the signature and shop name to the current session</span>
</span><span class='line'>  <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;shopify_signature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">];</span>
</span><span class='line'>  <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;shop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$shop</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Location: http://localhost/shopify_testing/shopify_app.php/admin.php&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we&rsquo;ve gone through the process of getting permissions for the app and written the code for it. It&rsquo;s time for you to actually install the app to the dev shop that you created earlier.
Apps are normally installed from the Shopify app store but we haven&rsquo;t submitted our app to the Shopify app store yet. So what we&rsquo;ll do is to go ahead and access the install URL for the app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">http://shop-name.myshopify.com/admin/api/auth?api_key=xyz</span>
</span></code></pre></td></tr></table></div></figure>


<p>Be sure to replace <code>shop-name</code> with the actual name of the dev shop that you created earlier. And the value for the <code>api_key</code> to be the actual api key for your app.</p>

<p>That specific URL is where the merchants will be ultimately redirected to once they install your app from the Shopify app store so we don&rsquo;t really need to submit our app to the app store yet. And Shopify won&rsquo;t really approve the app unless its well done. It has to go through some sort of review process to make sure that its safe for shop owners(merchants) to install it.</p>

<h3>Making API Requests</h3>

<p>Now that were done with the authentication part we can now make requests to the API.
Go ahead and create the <code>admin.php</code> file. That is where we make requests to the API to get some data about the shop were it is installed. But wait, we don&rsquo;t have any data to fetch from the shop yet. For starters go ahead and create some products on the dev shop that you created earlier. Come back here after you&rsquo;ve done that.</p>

<h4>Products</h4>

<p>Cool! Now you&rsquo;ve added some products to your shop. We can now fetch some of those products by talking to the API.
First you have to call the <code>client</code> method from the Shopify API library passing along the shop name, access token, api key and the shared secret. All of this data is already present in the database as long as the merchant has gone through the install process.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$shopify</span> <span class="o">=</span> <span class="nx">shopify_api\client</span><span class="p">(</span>
</span><span class='line'>  <span class="nv">$shop</span><span class="p">,</span> <span class="nv">$shop_data</span><span class="o">-&gt;</span><span class="na">access_token</span><span class="p">,</span> <span class="nv">$app_settings</span><span class="o">-&gt;</span><span class="na">api_key</span><span class="p">,</span> <span class="nv">$app_settings</span><span class="o">-&gt;</span><span class="na">shared_secret</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Once you&rsquo;re done with that you can now use the <code>$shopify</code> variable to call methods from the API.
Here were getting a list of products that are published in the shop:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$products</span> <span class="o">=</span> <span class="nv">$shopify</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/admin/products.json&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;published_status&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;published&#39;</span><span class="p">));</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>The first argument that we specify above is the request method. It can either be <code>GET</code> or <code>POST</code> depending on what&rsquo;s included in the documentation. Some methods require <code>GET</code> as the request method and some require <code>POST</code>. But the common pattern is that when you&rsquo;re modifying or creating something the request method to use is <code>POST</code>, but when only retrieving specific data you use <code>GET</code>.</p>

<p>The second argument is the resource that you&rsquo;re trying to access. In this case were accessing <code>products.json</code> which refers to the products in the shop.</p>

<p>The third argument is an array of arguments that you want to pass. There&rsquo;s a bunch of arguments that you can pass with the <code>products</code> resource. In the above example we used the <code>published_status</code> and supplied <code>published</code> as its value. This is like saying to the API that we only want to get the products which are published. In shopify products can either be draft or published. Published means that its already viewable by customers in your shop. It means that the merchant is already displaying the product for sale.
There&rsquo;s also the <code>product_type</code> argument this allows you to limit the products returned for a specific product type only. For example you only want to return perishable goods.</p>

<p>Here&rsquo;s a sample response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Array</span>
</span><span class='line'><span class="x">(</span>
</span><span class='line'><span class="x">    [0] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [body_html] =&gt; Crested shirt</span>
</span><span class='line'><span class="x">            [created_at] =&gt; 2013-10-13T23:09:53-04:00</span>
</span><span class='line'><span class="x">            [handle] =&gt; crested-shirt</span>
</span><span class='line'><span class="x">            [id] =&gt; 164668989</span>
</span><span class='line'><span class="x">            [product_type] =&gt; t-shirts</span>
</span><span class='line'><span class="x">            [published_at] =&gt; 2013-10-13T23:09:13-04:00</span>
</span><span class='line'><span class="x">            [published_scope] =&gt; global</span>
</span><span class='line'><span class="x">            [template_suffix] =&gt; </span>
</span><span class='line'><span class="x">            [title] =&gt; Crested shirt</span>
</span><span class='line'><span class="x">            [updated_at] =&gt; 2013-10-14T01:31:44-04:00</span>
</span><span class='line'><span class="x">            [vendor] =&gt; zentopia</span>
</span><span class='line'><span class="x">            [tags] =&gt; </span>
</span><span class='line'><span class="x">            [variants] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                            [barcode] =&gt; </span>
</span><span class='line'><span class="x">                            [compare_at_price] =&gt; </span>
</span><span class='line'><span class="x">                            [created_at] =&gt; 2013-10-13T23:09:53-04:00</span>
</span><span class='line'><span class="x">                            [fulfillment_service] =&gt; manual</span>
</span><span class='line'><span class="x">                            [grams] =&gt; 234</span>
</span><span class='line'><span class="x">                            [id] =&gt; 378254785</span>
</span><span class='line'><span class="x">                            [inventory_management] =&gt; </span>
</span><span class='line'><span class="x">                            [inventory_policy] =&gt; deny</span>
</span><span class='line'><span class="x">                            [option1] =&gt; Default Title</span>
</span><span class='line'><span class="x">                            [option2] =&gt; </span>
</span><span class='line'><span class="x">                            [option3] =&gt; </span>
</span><span class='line'><span class="x">                            [position] =&gt; 1</span>
</span><span class='line'><span class="x">                            [price] =&gt; 322.00</span>
</span><span class='line'><span class="x">                            [product_id] =&gt; 164668989</span>
</span><span class='line'><span class="x">                            [requires_shipping] =&gt; 1</span>
</span><span class='line'><span class="x">                            [sku] =&gt; </span>
</span><span class='line'><span class="x">                            [taxable] =&gt; 1</span>
</span><span class='line'><span class="x">                            [title] =&gt; Default Title</span>
</span><span class='line'><span class="x">                            [updated_at] =&gt; 2013-10-13T23:09:53-04:00</span>
</span><span class='line'><span class="x">                            [inventory_quantity] =&gt; 0</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [options] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                            [id] =&gt; 197676733</span>
</span><span class='line'><span class="x">                            [name] =&gt; Title</span>
</span><span class='line'><span class="x">                            [position] =&gt; 1</span>
</span><span class='line'><span class="x">                            [product_id] =&gt; 164668989</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [images] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                            [created_at] =&gt; 2013-10-14T01:31:39-04:00</span>
</span><span class='line'><span class="x">                            [id] =&gt; 330590691</span>
</span><span class='line'><span class="x">                            [position] =&gt; 1</span>
</span><span class='line'><span class="x">                            [product_id] =&gt; 164668989</span>
</span><span class='line'><span class="x">                            [updated_at] =&gt; 2013-10-14T01:31:39-04:00</span>
</span><span class='line'><span class="x">                            [src] =&gt; http://cdn.shopify.com/s/files/1/0279/0287/products/crest.jpg?305</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [image] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [created_at] =&gt; 2013-10-14T01:31:39-04:00</span>
</span><span class='line'><span class="x">                    [id] =&gt; 330590691</span>
</span><span class='line'><span class="x">                    [position] =&gt; 1</span>
</span><span class='line'><span class="x">                    [product_id] =&gt; 164668989</span>
</span><span class='line'><span class="x">                    [updated_at] =&gt; 2013-10-14T01:31:39-04:00</span>
</span><span class='line'><span class="x">                    [src] =&gt; http://cdn.shopify.com/s/files/1/0279/0287/products/crest.jpg?305</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'><span class="x">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that you can also specify the fields that you want to return by using the <code>fields</code> as an argument and supply a comma-separated list of the fields that you want to return. Something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$arguments</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;published_status&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;published&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;fields&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;body_html,created_at,handle,id,title,image&#39;</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$products</span> <span class="o">=</span> <span class="nv">$shopify</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/admin/products.json&#39;</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>The documentation for the products is available <a href="http://docs.shopify.com/api/product#index">here</a>.
Go through it so you know what other methods you can call that involves the products in the shop.</p>

<h4>Orders</h4>

<p>You can also access information about <a href="http://docs.shopify.com/api/order">orders</a> using the API.</p>

<p>To get a list of orders:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$arguments</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;limit&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="c1">//default: 50</span>
</span><span class='line'>  <span class="s1">&#39;page&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="c1">//default: 1</span>
</span><span class='line'>  <span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="nv">$orders</span> <span class="o">=</span> <span class="nv">$shopify</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/admin/orders.json&#39;</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s a sample response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Array</span>
</span><span class='line'><span class="x">(</span>
</span><span class='line'><span class="x">    [0] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [buyer_accepts_marketing] =&gt; 1</span>
</span><span class='line'><span class="x">            [cancel_reason] =&gt; </span>
</span><span class='line'><span class="x">            [cancelled_at] =&gt; </span>
</span><span class='line'><span class="x">            [cart_token] =&gt; ba56ddbaab418b79566316fe5e99e4e3</span>
</span><span class='line'><span class="x">            [checkout_token] =&gt; 2b4ef76523c1bb6fc6e6825a97a4c992</span>
</span><span class='line'><span class="x">            [closed_at] =&gt; </span>
</span><span class='line'><span class="x">            [confirmed] =&gt; 1</span>
</span><span class='line'><span class="x">            [created_at] =&gt; 2013-10-17T00:13:59-04:00</span>
</span><span class='line'><span class="x">            [currency] =&gt; PHP</span>
</span><span class='line'><span class="x">            [email] =&gt; vbcanc@gmail.com</span>
</span><span class='line'><span class="x">            [financial_status] =&gt; authorized</span>
</span><span class='line'><span class="x">            [fulfillment_status] =&gt; </span>
</span><span class='line'><span class="x">            [gateway] =&gt; bogus</span>
</span><span class='line'><span class="x">            [id] =&gt; 188680051</span>
</span><span class='line'><span class="x">            [landing_site] =&gt; /</span>
</span><span class='line'><span class="x">            [location_id] =&gt; </span>
</span><span class='line'><span class="x">            [name] =&gt; #1001</span>
</span><span class='line'><span class="x">            [note] =&gt; </span>
</span><span class='line'><span class="x">            [number] =&gt; 1</span>
</span><span class='line'><span class="x">            [reference] =&gt; </span>
</span><span class='line'><span class="x">            [referring_site] =&gt; </span>
</span><span class='line'><span class="x">            [source] =&gt; browser</span>
</span><span class='line'><span class="x">            [subtotal_price] =&gt; 322.00</span>
</span><span class='line'><span class="x">            [taxes_included] =&gt; </span>
</span><span class='line'><span class="x">            [test] =&gt; 1</span>
</span><span class='line'><span class="x">            [token] =&gt; 35330c6d0bb04c0198ab94b04317e1af</span>
</span><span class='line'><span class="x">            [total_discounts] =&gt; 0.00</span>
</span><span class='line'><span class="x">            [total_line_items_price] =&gt; 322.00</span>
</span><span class='line'><span class="x">            [total_price] =&gt; 342.00</span>
</span><span class='line'><span class="x">            [total_price_usd] =&gt; 7.93</span>
</span><span class='line'><span class="x">            [total_tax] =&gt; 0.00</span>
</span><span class='line'><span class="x">            [total_weight] =&gt; 234</span>
</span><span class='line'><span class="x">            [updated_at] =&gt; 2013-10-17T00:13:59-04:00</span>
</span><span class='line'><span class="x">            [user_id] =&gt; </span>
</span><span class='line'><span class="x">            [browser_ip] =&gt; 180.191.38.211</span>
</span><span class='line'><span class="x">            [landing_site_ref] =&gt; </span>
</span><span class='line'><span class="x">            [order_number] =&gt; 1001</span>
</span><span class='line'><span class="x">            [discount_codes] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [note_attributes] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [processing_method] =&gt; direct</span>
</span><span class='line'><span class="x">            [checkout_id] =&gt; 140790649</span>
</span><span class='line'><span class="x">            [source_name] =&gt; web</span>
</span><span class='line'><span class="x">            [line_items] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                            [fulfillment_service] =&gt; manual</span>
</span><span class='line'><span class="x">                            [fulfillment_status] =&gt; </span>
</span><span class='line'><span class="x">                            [grams] =&gt; 234</span>
</span><span class='line'><span class="x">                            [id] =&gt; 328820335</span>
</span><span class='line'><span class="x">                            [price] =&gt; 322.00</span>
</span><span class='line'><span class="x">                            [product_id] =&gt; 164668989</span>
</span><span class='line'><span class="x">                            [quantity] =&gt; 1</span>
</span><span class='line'><span class="x">                            [requires_shipping] =&gt; 1</span>
</span><span class='line'><span class="x">                            [sku] =&gt; </span>
</span><span class='line'><span class="x">                            [title] =&gt; Crested shirt</span>
</span><span class='line'><span class="x">                            [variant_id] =&gt; 378254785</span>
</span><span class='line'><span class="x">                            [variant_title] =&gt; </span>
</span><span class='line'><span class="x">                            [vendor] =&gt; zentopia</span>
</span><span class='line'><span class="x">                            [name] =&gt; Crested shirt</span>
</span><span class='line'><span class="x">                            [variant_inventory_management] =&gt; </span>
</span><span class='line'><span class="x">                            [properties] =&gt; Array</span>
</span><span class='line'><span class="x">                                (</span>
</span><span class='line'><span class="x">                                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">                            [product_exists] =&gt; 1</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [shipping_lines] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                            [code] =&gt; International Shipping</span>
</span><span class='line'><span class="x">                            [price] =&gt; 20.00</span>
</span><span class='line'><span class="x">                            [source] =&gt; shopify</span>
</span><span class='line'><span class="x">                            [title] =&gt; International Shipping</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [tax_lines] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [payment_details] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [avs_result_code] =&gt; </span>
</span><span class='line'><span class="x">                    [credit_card_bin] =&gt; 1</span>
</span><span class='line'><span class="x">                    [cvv_result_code] =&gt; </span>
</span><span class='line'><span class="x">                    [credit_card_number] =&gt; XXXX-XXXX-XXXX-1</span>
</span><span class='line'><span class="x">                    [credit_card_company] =&gt; Bogus</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [billing_address] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [address1] =&gt; 86-92 &amp; 103 Brighton Road Coulsdon Surrey</span>
</span><span class='line'><span class="x">                    [address2] =&gt; </span>
</span><span class='line'><span class="x">                    [city] =&gt; Coulsdon</span>
</span><span class='line'><span class="x">                    [company] =&gt; doble</span>
</span><span class='line'><span class="x">                    [country] =&gt; United Kingdom</span>
</span><span class='line'><span class="x">                    [first_name] =&gt; sfs</span>
</span><span class='line'><span class="x">                    [last_name] =&gt; rew</span>
</span><span class='line'><span class="x">                    [latitude] =&gt; 51.314819</span>
</span><span class='line'><span class="x">                    [longitude] =&gt; -0.12435</span>
</span><span class='line'><span class="x">                    [phone] =&gt; 3252325</span>
</span><span class='line'><span class="x">                    [province] =&gt; Surrey</span>
</span><span class='line'><span class="x">                    [zip] =&gt; CR5 2NG</span>
</span><span class='line'><span class="x">                    [name] =&gt; sfs rew</span>
</span><span class='line'><span class="x">                    [country_code] =&gt; GB</span>
</span><span class='line'><span class="x">                    [province_code] =&gt; </span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [shipping_address] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [address1] =&gt; 86-92 &amp; 103 Brighton Road Coulsdon Surrey</span>
</span><span class='line'><span class="x">                    [address2] =&gt; </span>
</span><span class='line'><span class="x">                    [city] =&gt; Coulsdon</span>
</span><span class='line'><span class="x">                    [company] =&gt; doble</span>
</span><span class='line'><span class="x">                    [country] =&gt; United Kingdom</span>
</span><span class='line'><span class="x">                    [first_name] =&gt; sfs</span>
</span><span class='line'><span class="x">                    [last_name] =&gt; rew</span>
</span><span class='line'><span class="x">                    [latitude] =&gt; 51.314819</span>
</span><span class='line'><span class="x">                    [longitude] =&gt; -0.12435</span>
</span><span class='line'><span class="x">                    [phone] =&gt; 3252325</span>
</span><span class='line'><span class="x">                    [province] =&gt; Surrey</span>
</span><span class='line'><span class="x">                    [zip] =&gt; CR5 2NG</span>
</span><span class='line'><span class="x">                    [name] =&gt; sfs rew</span>
</span><span class='line'><span class="x">                    [country_code] =&gt; GB</span>
</span><span class='line'><span class="x">                    [province_code] =&gt; </span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [fulfillments] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [client_details] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [accept_language] =&gt; en-US,en;q=0.8</span>
</span><span class='line'><span class="x">                    [browser_ip] =&gt; xxx.xxx.xx.xxx</span>
</span><span class='line'><span class="x">                    [session_hash] =&gt; 4bb858f172df6367b05ab424f9c6bd0f778e711e9046c5a13833cc91bc33a237</span>
</span><span class='line'><span class="x">                    [user_agent] =&gt; Mozilla/5.0 (X11; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/28.0.1500.71 Chrome/28.0.1500.71 Safari/537.36</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [customer] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [accepts_marketing] =&gt; 1</span>
</span><span class='line'><span class="x">                    [created_at] =&gt; 2013-10-15T21:26:24-04:00</span>
</span><span class='line'><span class="x">                    [email] =&gt; vbcanc@gmail.com</span>
</span><span class='line'><span class="x">                    [first_name] =&gt; wef</span>
</span><span class='line'><span class="x">                    [id] =&gt; 148878735</span>
</span><span class='line'><span class="x">                    [last_name] =&gt; rew</span>
</span><span class='line'><span class="x">                    [last_order_id] =&gt; </span>
</span><span class='line'><span class="x">                    [multipass_identifier] =&gt; </span>
</span><span class='line'><span class="x">                    [note] =&gt; </span>
</span><span class='line'><span class="x">                    [orders_count] =&gt; 0</span>
</span><span class='line'><span class="x">                    [state] =&gt; disabled</span>
</span><span class='line'><span class="x">                    [total_spent] =&gt; 0.00</span>
</span><span class='line'><span class="x">                    [updated_at] =&gt; 2013-10-17T00:14:01-04:00</span>
</span><span class='line'><span class="x">                    [verified_email] =&gt; 1</span>
</span><span class='line'><span class="x">                    [tags] =&gt; </span>
</span><span class='line'><span class="x">                    [last_order_name] =&gt; </span>
</span><span class='line'><span class="x">                    [image_url] =&gt; //gravatar.com/avatar/aba221e4cb888289b95b7864d754c4ce?default=http%3A%2F%2Fcdn.shopify.com%2Fs%2Fimages%2Fadmin%2Fcustomers%2Fcustomers_avatar_england_londonbridge.png</span>
</span><span class='line'><span class="x">                    [default_address] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                            [address1] =&gt; 86-92 &amp; 103 Brighton Road Coulsdon Surrey</span>
</span><span class='line'><span class="x">                            [address2] =&gt; </span>
</span><span class='line'><span class="x">                            [city] =&gt; Coulsdon</span>
</span><span class='line'><span class="x">                            [company] =&gt; doble</span>
</span><span class='line'><span class="x">                            [country] =&gt; United Kingdom</span>
</span><span class='line'><span class="x">                            [first_name] =&gt; sfs</span>
</span><span class='line'><span class="x">                            [id] =&gt; 193735639</span>
</span><span class='line'><span class="x">                            [last_name] =&gt; rew</span>
</span><span class='line'><span class="x">                            [phone] =&gt; 3252325</span>
</span><span class='line'><span class="x">                            [province] =&gt; Surrey</span>
</span><span class='line'><span class="x">                            [zip] =&gt; CR5 2NG</span>
</span><span class='line'><span class="x">                            [name] =&gt; sfs rew</span>
</span><span class='line'><span class="x">                            [province_code] =&gt; </span>
</span><span class='line'><span class="x">                            [country_code] =&gt; GB</span>
</span><span class='line'><span class="x">                            [country_name] =&gt; United Kingdom</span>
</span><span class='line'><span class="x">                            [default] =&gt; 1</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see from the above response all information about a specific order is returned. The line items, payment details, billing address and customer information are all included in the default response.
Information about the device (IP address, browser) were the order was made is also captured by Shopify.</p>

<h4>Webhooks</h4>

<p>The Shopify API also supports webhooks. In case you don&rsquo;t know what a webhook is here&rsquo;s a good definition from <a href="http://en.wikipedia.org/wiki/Webhook">Wikipedia</a>:</p>

<blockquote><p>A Webhook, in web development, is a method of augmenting or altering the behavior of a web page, or web application, with custom callbacks. These callbacks may be maintained, modified, and managed by third-party users and developers who may not necessarily be affiliated with the originating website or application.</p></blockquote>


<p>In simple terms a webhook is used to perform specific actions when a certain event happens. In Shopify there are a number of events which you can hook into to perform specific action:</p>

<p>Webhooks can be set from the dev shop or from the app. To set a webhook from the dev shop go to the admin page of your shop, click on the settings tab then click on notifications tab. Scroll down until you find the webhooks section. To create a new webhook just click on the <code>create a webhook</code> button. Then select the event in which you want to add a webhook then enter the complete URL of the page where you want to submit the data when the specific event happens.</p>

<p><img src="/images/posts/getting_started_with_shopify_app_development/webhook.png" alt="Webhook" /></p>

<p>To add a webhook via the API simply make a <code>POST</code> request to the <code>webhooks</code> resource and passing in the <code>topic</code> and <code>address</code>. The <code>topic</code> is the actual event and the <code>address</code> is the URL which you want to submit the data returned from the specific event when it happens. Do note that we can&rsquo;t use the local server URL for this. It must be a URL that&rsquo;s actually accessible from the internet. In the example below were submitting the data to the address specified when a cart is created or updated.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="c1">//when cart is created</span>
</span><span class='line'><span class="nv">$arguments</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;topic&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;cart/creation&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;address&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;http://somewhere.com/update_inventory.php&#39;</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$webhooks</span> <span class="o">=</span> <span class="nv">$shopify</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/admin/webhooks.json&#39;</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//when cart is updated</span>
</span><span class='line'><span class="nv">$arguments</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;topic&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;cart/update&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;address&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;http://somewhere.com/update_inventory.php&#39;</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$webhooks</span> <span class="o">=</span> <span class="nv">$shopify</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/admin/webhooks.json&#39;</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember that every event where you can hook upon in the admin interface you can also create a hook on it using the API. You can read more about webhooks <a href="http://docs.shopify.com/api/tutorials/using-webhooks">here</a>.</p>

<p>If you want to check what specific data is being passed to the URL that you specify for a specific webhook you can use a service like <a href="http://requestb.in/">request bin</a></p>

<p>Heres a sample request for when a cart is created. You can use the properties under the <code>data</code> property as a basis for the data that you&rsquo;re going to access from the address that you specified in your webhook:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://api.yourapihere.com/&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;X-Shopify-Topic&quot;</span><span class="p">:</span> <span class="s2">&quot;carts/create&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Host&quot;</span><span class="p">:</span> <span class="s2">&quot;api.yourapihere.com&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip, deflate, compress&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;X-Shopify-Shop-Domain&quot;</span><span class="p">:</span> <span class="s2">&quot;test-shop.myshopify.com&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Ruby&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Content-Length&quot;</span><span class="p">:</span> <span class="s2">&quot;281&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;*/*&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;args&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span class='line'>  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;{\&quot;id\&quot;:\&quot;carts:eeafa272cebfd4b22385bc4b645e762c\&quot;,\&quot;token\&quot;:\&quot;eeafa272cebfd4b22385bc4b645e762c\&quot;,\&quot;line_items\&quot;:[{\&quot;id\&quot;:null,\&quot;title\&quot;:\&quot;Example T-Shirt\&quot;,\&quot;price\&quot;:\&quot;19.99\&quot;,\&quot;line_price\&quot;:\&quot;59.97\&quot;,\&quot;quantity\&quot;:3,\&quot;sku\&quot;:\&quot;example-shirt-s\&quot;,\&quot;grams\&quot;:200,\&quot;vendor\&quot;:\&quot;Acme\&quot;,\&quot;properties\&quot;:null,\&quot;variant_id\&quot;:null}]}&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;54.236.226.56&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;form&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span class='line'>  <span class="nt">&quot;files&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span class='line'>  <span class="nt">&quot;json&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;carts:eeafa272cebfd4b22385bc4b645e762c&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;line_items&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;sku&quot;</span><span class="p">:</span> <span class="s2">&quot;example-shirt-s&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;variant_id&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;vendor&quot;</span><span class="p">:</span> <span class="s2">&quot;Acme&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;grams&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Example T-Shirt&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;price&quot;</span><span class="p">:</span> <span class="s2">&quot;19.99&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;line_price&quot;</span><span class="p">:</span> <span class="s2">&quot;59.97&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;eeafa272cebfd4b22385bc4b645e762c&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The data that is passed to the address that you specified is an <a href="http://php.net/manual/en/wrappers.php.php">input stream</a>. It&rsquo;s not passed using the common <code>GET</code> or <code>POST</code> request method. You can use the <code>fopen()</code> method in PHP and pass in the <code>php://input</code> stream. Then pass in <code>rb</code> as the mode. <code>rb</code> means read-only in binary mode.
Then we just loop through the input stream until we reach the end of the file. Inside the loop we also use the <code>fread()</code> method to read from the resource created when we called <code>fopen()</code> earlier. We also pass the maximum number of bytes to read which is 4096 (approximately 4Mb). Finally we close the resource and convert the webhook content to an array using the <code>json_decode()</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$webhook_content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$webhook</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">&#39;php://input&#39;</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$webhook</span><span class="p">)){</span> <span class="c1">//loop through the input stream while the end of file is not reached</span>
</span><span class='line'>    <span class="nv">$webhook_content</span> <span class="o">.=</span> <span class="nb">fread</span><span class="p">(</span><span class="nv">$webhook</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span> <span class="c1">//append the content on the current iteration</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nb">fclose</span><span class="p">(</span><span class="nv">$webhook</span><span class="p">);</span> <span class="c1">//close the resource</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$webhook_content</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span> <span class="c1">//convert the json to array</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//do whatever you want with the data</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>That&rsquo;s it! You&rsquo;ve learned how to create a Shopify app. Creating a shopify app involves creating a Shopify partners account, a dev shop and an app. You&rsquo;ve also learned that Shopify apps aren&rsquo;t directly integrated into a shop, instead it is hosted somewhere else. Shopify apps are a nice way to extend the functionality that is already available to Shopify.</p>

<h2>Resources</h2>

<ul>
<li><a href="http://docs.shopify.com/api/the-basics/getting-started">The basics of Building a Shopify App</a></li>
<li><a href="http://www.shopify.com/technology/3671962-developing-shopify-apps-part-1-the-setup#axzz2itCLJCrk">Developing Shopify Apps</a></li>
<li><a href="https://github.com/sandeepshetty/shopify_api">Sandeepshetty/shopify_api</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/03/gettting-started-with-coinbase-api/">Gettting Started With Coinbase API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-03T13:34:00+08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/11/03/gettting-started-with-coinbase-api/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this article I&rsquo;ll be showing you how to get started developing applications which communicates with the Coinbase API. But first what is Coinbase?</p>

<blockquote><p>Coinbase is a service that allows you to use bitcoins as a means of payment for goods and services. <br/>Its like Paypal but for bitcoins.</p></blockquote>


<p>First thing that you need to do is to register an account with Coinbase.</p>

<p><img src="/images/posts/coinbase_api/coinbase-register.png" alt="register account" /></p>

<p>Then go to your email and verify the account.</p>

<p>Accept the license.</p>

<p><img src="/images/posts/coinbase_api/coinbase-license.png" alt="accept license" /></p>

<p>Next, click on account settings and then click on the integrations tab:</p>

<p><img src="/images/posts/coinbase_api/coinbase-api.png" alt="integrations" /></p>

<p>Next, click on show my API key. You would need to enter your password to verify that you are indeed the account owner. Initially the API key is disabled so you need to enable it as well.</p>

<p><img src="/images/posts/coinbase_api/enable-apikey.png" alt="enable api key" /></p>

<p>After that, simply copy the API key that&rsquo;s displayed.</p>

<p><img src="/images/posts/coinbase_api/copy-apikey.png" alt="copy api key" /></p>

<p>The API key will be used for authenticating requests to the Coinbase API.</p>

<h3>Authentication</h3>

<p>There are 2 ways in which a request to the API can be authenticated:</p>

<ol>
<li>API key</li>
<li>OAuth2</li>
</ol>


<h4>Authentication using API Key</h4>

<p>Authenticating a request via the API Key is the easier way of making requests to the API. All you have to do is to append the api key on each request. The cool thing is you can directly execute a request to the API directly from the browser for methods that can be called via <code>GET</code>.</p>

<p>For example when you want to get the account balance, you simply do something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://coinbase.com/api/v1/account/balance?api_key=xyz</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s a bunch of other methods which you can call directly from the browser. They&rsquo;re all listed <a href="https://coinbase.com/api/doc/1.0.html">here</a>. Do note that you can only call a method directly from the browser when its request method is <code>GET</code>. <code>POST</code> methods cannot be called directly from the browser, you need to use <code>curl</code> or <code>file_get_contents()</code> to be able to make the request.</p>

<p>Here&rsquo;s an example of using <code>curl</code> to generate  a payment button, remember to pass the API Key along with the parameters required by the specific API method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>  <span class="nv">$request</span> <span class="o">=</span> <span class="s1">&#39;{</span>
</span><span class='line'><span class="s1">     &quot;api_key&quot; : &quot;xyz&quot;, </span>
</span><span class='line'><span class="s1">     &quot;button&quot;: {</span>
</span><span class='line'><span class="s1">         &quot;name&quot;: &quot;test&quot;,</span>
</span><span class='line'><span class="s1">         &quot;price_string&quot;: &quot;1.23&quot;,</span>
</span><span class='line'><span class="s1">         &quot;price_currency_iso&quot;: &quot;USD&quot;</span>
</span><span class='line'><span class="s1">         }</span>
</span><span class='line'><span class="s1"> }&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$post_fields</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span> <span class="c1">//convert json string to an object</span>
</span><span class='line'>    <span class="nv">$post_fields</span> <span class="o">=</span> <span class="nb">http_build_query</span><span class="p">(</span><span class="nv">$post_fields</span><span class="p">);</span> <span class="c1">//urlencode for arrays</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$curl</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="nx">CURLOPT_POST</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span> <span class="c1">//tell curl that were posting some data along with the request </span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="nx">CURLOPT_POSTFIELDS</span><span class="p">,</span> <span class="nv">$post_fields</span><span class="p">);</span> <span class="c1">//the data that we want to post</span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="s1">&#39;https://coinbase.com/api/v1/buttons&#39;</span><span class="p">);</span> <span class="c1">//the request url</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span> <span class="c1">//return the transfer, by default its being echoed out</span>
</span><span class='line'>  <span class="nv">$response</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$curl</span><span class="p">);</span> <span class="c1">//execute the request</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>The method that we have used above is the <code>buttons</code> method. It only requires 3 arguments:</p>

<ul>
<li><p><strong>button[name]</strong> &ndash; the name of the item or service for which you are collecting bitcoins.</p></li>
<li><p><strong>button[price_string]</strong> &ndash; the total price of the item or service.</p></li>
<li><p><strong>button[price_currency_iso]</strong> &ndash; the currency of the price used in the <code>button[price_string]</code> argument. Examples are <code>USD</code>, <code>PHP</code>, <code>SGD</code>, <code>CAD</code>, or <code>BTC</code> for the bitcoin currency. It would be easier if <code>BTC</code> isn&rsquo;t used so you won&rsquo;t have to convert. Simply use your local currency and the API will automatically convert it to <code>BTC</code> depending on the current exchange rate.</p></li>
</ul>


<p>The response would be formatted in JSON:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;success&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;button&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;93865b9cae83706ae59220c013bc0afd&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;buy_now&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;buy_now_large&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Pay With Bitcoin&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Sample description&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;custom&quot;</span><span class="p">:</span> <span class="s2">&quot;Order123&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;price&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;cents&quot;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;currency_iso&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To generate the payment button, simply create a div with a class of <code>coinbase-button</code> then give it a data attribute <code>data-code</code> using the button code as its value. After that create a new script element and use the <code>button.js</code> from coinbase:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;coinbase-button&quot;</span> <span class="na">data-code=</span><span class="s">&quot;&lt;?php echo $response-&gt;button-&gt;code; ?&gt;&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://coinbase.com/assets/button.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The response returned above can also be used for generating payment pages.
All you have to do is append the button code to the coinbase checkout url:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="cp">$response = json_decode($response); //convert json string to an object</span>
</span><span class='line'><span class="cp">?&gt;</span>
</span><span class='line'><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;https://coinbase.com/checkouts/&lt;?php echo $response-&gt;button-&gt;code; ?&gt;&quot;</span><span class="nt">&gt;</span>Checkout<span class="nt">&lt;/a&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Authentication using OAuth2</h4>

<p>Authentication using OAuth2 is a bit difficult. Thankfully there are good people out there who creates libraries that makes our lives easier. One of those libraries is the <a href="https://github.com/coinbase/coinbase-php">Coinbase-PHP</a> library.</p>

<p>To use it, simply download the zip file from the Github repository or clone it on your machine. Once the download is done, you can just include it on your working script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">require</span> <span class="s1">&#39;libs/coinbase/Coinbase.php&#39;</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>After that, you can go ahead and call the methods available from the library. In the example below were calling the <code>getOrders()</code> method which simply returns all the orders received by the merchant who owns the API Key that is used in the code. This means that every merchant who plans to integrate Coinbase in their application has to create their own Coinbase app in order to receive an API Key. The API Key will then serve as their identification for each request that is made to the API. Yes this is a bit of a drag for the merchants but that&rsquo;s just how it works so there&rsquo;s no choice but to stick with it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$api_key</span> <span class="o">=</span> <span class="s1">&#39;xyz&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$coinbase</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Coinbase</span><span class="p">(</span><span class="nv">$api_key</span><span class="p">);</span>
</span><span class='line'><span class="nv">$orders</span> <span class="o">=</span> <span class="nv">$coinbase</span><span class="o">-&gt;</span><span class="na">getOrders</span><span class="p">();</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>The response returned from the code above is not the same as the response that you directly get from the API.
The library already converts it to an object so there&rsquo;s no need to. Here&rsquo;s an example of looping through the orders:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$orders</span><span class="o">-&gt;</span><span class="na">total_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">foreach</span><span class="p">(</span><span class="nv">$orders</span><span class="o">-&gt;</span><span class="na">orders</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">){</span>
</span><span class='line'>                  
</span><span class='line'>      <span class="k">echo</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">order</span><span class="o">-&gt;</span><span class="na">created_at</span><span class="p">;</span>
</span><span class='line'>      <span class="k">echo</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">order</span><span class="o">-&gt;</span><span class="na">button</span><span class="o">-&gt;</span><span class="na">description</span><span class="p">;</span>
</span><span class='line'>      <span class="k">echo</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">order</span><span class="o">-&gt;</span><span class="na">status</span><span class="p">;</span>
</span><span class='line'>      <span class="k">echo</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">order</span><span class="o">-&gt;</span><span class="na">total_native</span><span class="o">-&gt;</span><span class="na">cents</span><span class="p">;</span>
</span><span class='line'>      <span class="k">echo</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">order</span><span class="o">-&gt;</span><span class="na">button</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
</span><span class='line'>          
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>You&rsquo;ve learned how to perform requests to the Coinbase API. Requests can be performed directly from the browser or via Curl. You have also learned how to generate payment buttons via the API.</p>

<h2>Resources</h2>

<ul>
<li><a href="https://coinbase.com/api/doc/1.0.html">API Documentation</a></li>
<li><a href="https://github.com/coinbase/coinbase-php">Coinbase-PHP</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/24/how-to-perform-cross-domain-ajax-requests/">How to Perform Cross-domain AJAX Requests</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-24T18:30:00+08:00" pubdate data-updated="true">Oct 24<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/24/how-to-perform-cross-domain-ajax-requests/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this article I&rsquo;m going to show you how you can perform cross-domain AJAX requests.
There&rsquo;s really no bullet-proof method of doing this. It might work, it might not since AJAX requests should only be performed within the same domain due to security concerns.</p>

<p>Note that I&rsquo;m not going to show how to perform an AJAX request to any domain from any domain. What I&rsquo;m going to show you is how to perform an AJAX request to a different domain which you have control over the code.</p>

<p>For example you want to get some data via AJAX from <code>xyz.com</code>. You are making the request from <code>abc.com</code> so it wouldn&rsquo;t work if you do something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;http://xyz.com/get_data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span> <span class="o">:</span> <span class="s1">&#39;abc&#39;</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//do something with the response</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you have control over the code that returns the response that you need, all you need to do is to convert the data that you&rsquo;re returning to JSON string and then wrap it up with a function call. Here&rsquo;s an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;fname&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;haru&#39;</span><span class="p">,</span> <span class="s1">&#39;lname&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tora&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">echo</span> <span class="s2">&quot;parse_results(&quot;</span> <span class="o">.</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p> entry_title</p>

<p>When calling the method from <code>abc.com</code> all you have to do is to use the <code>$.getJSON()</code> method and declare the same function that you used on <code>xyz.com</code>. In this case the name of the function is <code>parse_results()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">parse_results</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//do something with the response</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;http://xyz.com/get_data&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span> <span class="o">:</span> <span class="s1">&#39;abc&#39;</span><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can also use the more robust <code>$.ajax()</code> method if you want:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">parse_results</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//do something with the response</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;http://xyz.com/get_data&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">type</span> <span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">data</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="s1">&#39;data&#39;</span> <span class="o">:</span> <span class="s1">&#39;abc&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/20/getting-started-with-delicious-api/">Getting Started With Delicious API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-20T13:17:00+08:00" pubdate data-updated="true">Oct 20<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/20/getting-started-with-delicious-api/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this article I&rsquo;ll be showing you how to get the links that you have bookmarked using Delicious using the Delicious API.</p>

<p>The Delicious API unlike other Web API&rsquo;s that&rsquo;s using either OAuth, OAuth2 or their custom Authentication method is using <a href="http://en.wikipedia.org/wiki/Basic_access_authentication">Basic Access Authentication</a>. This means that performing API calls requires the username and the password of the user whose bookmarks you want to have access to.
This means that there&rsquo;s no confidentiality with this Authentication method. Without you knowing, the application that&rsquo;s going to do the talking with the Delicious API can just save your username and password in a database and the developers can have access to the links that you&rsquo;ve bookmarked in your account whether public or private. So as a user its recommended that you only bookmark links that doesn&rsquo;t contain any confidential or classified information.</p>

<h3>Delicious Class</h3>

<p>First let&rsquo;s go ahead and create the class that we will be using to access the Delicious API. Let&rsquo;s name it <code>class.delicious.php</code>. Then declare the 4 private variables that we will be using throughout the class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">delicious</span><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$curl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$curl_options</span><span class="p">;</span> <span class="c1">//options that will be used for curl</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$username</span><span class="p">;</span> <span class="c1">//delicious username</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$password</span><span class="p">;</span> <span class="c1">//delicious password</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>The constructor will accept 2 arguments, the delicious username and password. We&rsquo;ll also initialize <code>curl</code> so we don&rsquo;t have to initialize it on every method call.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nv">$password</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, create the <code>set_options()</code> method. This method will simply set the curl options.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">set_options</span><span class="p">(){</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl_options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">CURLOPT_RETURNTRANSFER</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">//return the response from the delicious API.</span>
</span><span class='line'>        <span class="nx">CURLOPT_SSL_VERIFYPEER</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span> <span class="c1">//disable verification of the peer&#39;s certificate </span>
</span><span class='line'>        <span class="nx">CURLOPT_USERPWD</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">.</span> <span class="s1">&#39;:&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span> <span class="c1">//set the username and password to be used for authentication</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Next is the <code>execute()</code> method. This method is called from every method calls that are responsible for calling a specific method from the API. What it does is to assign the curl options to the curl object, executes it and then returns the response.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(){</span>
</span><span class='line'>    <span class="nb">curl_setopt_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl_options</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$response</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$response</span><span class="p">){</span>
</span><span class='line'>      <span class="c1">//terminate the execution of the script if there&#39;s no response</span>
</span><span class='line'>        <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Error: &quot;&#39;</span> <span class="o">.</span> <span class="nb">curl_error</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;&quot; - Code: &#39;</span> <span class="o">.</span> <span class="nb">curl_errno</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nb">curl_close</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl</span><span class="p">);</span> <span class="c1">//close the connection              </span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h4>Getting all Bookmarks</h4>

<p>We can now create the methods for actually getting the bookmarks. The first method that we will create is the <code>get_all()</code> method. As the name suggests, the <code>get_all()</code> method simply gets everything that you have ever bookmarked on your delicious account. This might take some time to execute depending on the number of links that you have bookmarked.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">get_all</span><span class="p">(){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set_options</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl_options</span><span class="p">[</span><span class="nx">CURLOPT_URL</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://api.del.icio.us/v1/posts/all&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$xml</span> <span class="o">=</span> <span class="nb">simplexml_load_string</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span> <span class="c1">//converts the string response into an xml object      </span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$xml</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Before we proceed with the next method, I&rsquo;d like you to take a few minutes to observe what were doing here.
Because the pattern that we&rsquo;ve used here will be used on other methods that we will be creating later.</p>

<p>As you can see, were calling the <code>set_options()</code> method to set the arguments that will be needed for the request.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set_options</span><span class="p">();</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we set the main URL that were requesting from. In this cae were requesting the <code>https://api.del.icio.us/v1/posts/all</code> url. At the time of writing of this article, the main request url is <code>https://api.del.icio.us</code> The version of the API is <code>v1</code> and the method is <code>posts/all</code>. You can see the full list of API methods that you can call <a href="https://github.com/avos/delicious-api/blob/master/APIs.md">here</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl_options</span><span class="p">[</span><span class="nx">CURLOPT_URL</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://api.del.icio.us/v1/posts/all&#39;</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we execute the request. The <code>execute()</code> method returns the response from the API. The response is basically in string format so we have to process it further to really get into the details that we want.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to do that we call the <code>simplexml_load_string()</code> method. It&rsquo;s a built-in PHP method which you can call to convert a string response into an XML object. You can read more about it <a href="http://php.net/manual/en/function.simplexml-load-string.php">here</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$xml</span> <span class="o">=</span> <span class="nb">simplexml_load_string</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>After converting the response to an XML object, we simply return it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">return</span> <span class="nv">$xml</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h4>Getting Bookmarks by Tag</h4>

<p>We can also get bookmarks by tag name. All we have to do is to specify the <code>tag</code> argument to the <code>posts/all</code> method and supply a url encoded value as the query.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">get_by_tag</span><span class="p">(</span><span class="nv">$tag</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set_options</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$request_url</span> <span class="o">=</span> <span class="s1">&#39;https://api.del.icio.us/v1/posts/all?tag=&#39;</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$tag</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl_options</span><span class="p">[</span><span class="nx">CURLOPT_URL</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$request_url</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$xml</span> <span class="o">=</span> <span class="nb">simplexml_load_string</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$xml</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h4>Getting Bookmarks by Offset</h4>

<p>We can also get by a certain limit and offset. All we have to do is supply a value for the <code>start</code> argument (offset), and the <code>results</code> argument (limit).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">get_by_offset</span><span class="p">(</span><span class="nv">$start</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set_options</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$request_url</span>  <span class="o">=</span> <span class="s1">&#39;https://api.del.icio.us/v1/posts/all?start=&#39;</span> <span class="o">.</span> <span class="nv">$start</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$request_url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;results=&#39;</span> <span class="o">.</span> <span class="nv">$limit</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl_options</span><span class="p">[</span><span class="nx">CURLOPT_URL</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$request_url</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$xml</span> <span class="o">=</span> <span class="nb">simplexml_load_string</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$xml</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h4>Getting Recently Bookmarked Links</h4>

<p>Recently bookmarked links can also be fetched from the API. The method to be used is the <code>posts/recent</code> method.
You can also supply an optional <code>tag</code> or <code>count</code> argument.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">get_recent</span><span class="p">(</span><span class="nv">$tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set_options</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$request_url</span>  <span class="o">=</span> <span class="s1">&#39;https://api.del.icio.us/v1/posts/recent?&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$tag</span><span class="p">)){</span> <span class="c1">//limit results by tag</span>
</span><span class='line'>      <span class="nv">$request_url</span> <span class="o">.=</span> <span class="s1">&#39;tag=&#39;</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$tag</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$count</span><span class="p">)){</span> <span class="c1">//limit results by bookmark count</span>
</span><span class='line'>      <span class="nv">$request_url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;count=&#39;</span> <span class="o">.</span> <span class="nv">$count</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl_options</span><span class="p">[</span><span class="nx">CURLOPT_URL</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$request_url</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$xml</span> <span class="o">=</span> <span class="nb">simplexml_load_string</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$xml</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h4>Bookmarking Links</h4>

<p>Bookmarking new links can also be done from the API. The method to be used is the <code>posts/add</code> method.
The <code>url</code> argument is required and you can also set an optional <code>description</code> or <code>tags</code>. If there are more than one tags you can separate them using a comma (E.g php, web-development)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$description</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$tags</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set_options</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$request_url</span>  <span class="o">=</span> <span class="s1">&#39;https://api.del.icio.us/v1/posts/add?&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$request_url</span> <span class="o">.=</span> <span class="s1">&#39;url=&#39;</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$request_url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;description=&#39;</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$description</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$request_url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;tags=&#39;</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$tags</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl_options</span><span class="p">[</span><span class="nx">CURLOPT_URL</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$request_url</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h4>Deleting Bookmarks</h4>

<p>You can also delete links that were previously bookmarked. The request method is <code>posts/delete</code>.
You have to pass in the <code>url</code> of the link that you wish to delete.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">delete</span><span class="p">(</span><span class="nv">$url</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set_options</span><span class="p">();</span>
</span><span class='line'>  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">curl_options</span><span class="p">[</span><span class="nx">CURLOPT_URL</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://api.del.icio.us/v1/posts/delete?url=&#39;</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">;</span>
</span><span class='line'>  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a bunch of other methods which you can use so be sure to check out the Delicious API documentation.</p>

<h3>Using the Class</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="k">require_once</span><span class="p">(</span><span class="s1">&#39;class.delicious.php&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$username</span> <span class="o">=</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$password</span> <span class="o">=</span> <span class="s1">&#39;secret&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$deli</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Delicious</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$links</span> <span class="o">=</span> <span class="nv">$deli</span><span class="o">-&gt;</span><span class="na">get_by_tag</span><span class="p">(</span><span class="s1">&#39;php&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">foreach</span><span class="p">(</span><span class="nv">$links</span><span class="o">-&gt;</span><span class="na">post</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">){</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;li&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="x">&lt;/li&gt;</span>
</span><span class='line'><span class="cp">&lt;?php</span>  
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h3>Resources</h3>

<ul>
<li><a href="https://github.com/avos/delicious-api/blob/master/APIs.md">Delicious API</a></li>
<li><a href="https://github.com/anchetaWern/delicious-php">Delicious-PHP</a> &ndash; a little PHP class that I created for interacting with the Delicious API</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/13/how-to-modify-the-results-from-the-search-api-solr-module/">How to Modify the Results From the Search API Solr Module</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-13T13:15:00+08:00" pubdate data-updated="true">Oct 13<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/13/how-to-modify-the-results-from-the-search-api-solr-module/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The <a href="https://drupal.org/project/search_api_solr">Search API Solr module</a> for Drupal is a nice way to use Solr as the server for the <a href="https://drupal.org/project/search_api">Search API module</a>. Its pretty flexible with customizing the data that you want to return from the server but what if you need something that&rsquo;s not directly available from the Solr server? What if you also need the data to be available to the client side and do some kind of data manipulation from there?</p>

<p>In this article I&rsquo;ll be showing you how to do just that. We will be creating a custom module that will tap into the API of the Search API Solr Module to modify the default results that are returned and make it available to the client side.</p>

<h4>Module Information</h4>

<p>Let&rsquo;s begin by creating the <code>.info</code> file for our custom module:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>name = searchapisolrmod
</span><span class='line'>description = "Modifies the results returned from the Search API Solr Module"
</span><span class='line'>package = Nrue
</span><span class='line'>core = 7.x 
</span><span class='line'>files[] = searchapisolrmod.module
</span><span class='line'>files[] = searchapisolrmod.install</span></code></pre></td></tr></table></div></figure>


<h4>Use Case</h4>

<p>Before we dive into the &lsquo;how&rsquo; let me tell you about a sample use case first.
For example, we have the following data stored in the Solr server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="err">id:</span> <span class="err">&#39;123&#39;,</span>
</span><span class='line'>      <span class="err">business_name:</span> <span class="err">&#39;Antares&#39;,</span>
</span><span class='line'>      <span class="err">business_address:postal_code:</span> <span class="err">&#39;2500</span> <span class="err">AC&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="err">id:</span> <span class="err">&#39;456&#39;,</span>
</span><span class='line'>      <span class="err">business_name:</span> <span class="err">&#39;Aldebaran&#39;,</span>
</span><span class='line'>      <span class="err">business_address:postal_code:</span> <span class="err">&#39;3420</span> <span class="err">AD&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="err">id:</span> <span class="err">&#39;352&#39;,</span>
</span><span class='line'>      <span class="err">business_name:</span> <span class="err">&#39;Cassiopeia&#39;,</span>
</span><span class='line'>      <span class="err">business_address:postal_code:</span> <span class="err">&#39;1288</span> <span class="err">XD&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="err">id:</span> <span class="err">&#39;93&#39;,</span>
</span><span class='line'>      <span class="err">business_name:</span> <span class="err">&#39;Regulus&#39;,</span>
</span><span class='line'>      <span class="err">business_address:postal_code:</span> <span class="err">&#39;671</span> <span class="err">CC&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>But we want to display the location of the business in Google Maps by using the postal code as the query.
Normally we would want to actually update the data that&rsquo;s in the Solr server so there will be no need to modify the results from it. But what if we don&rsquo;t have access to the Solr server? What if its a remote server run by someone else? For that we will need to actually modify the results as they are returned.</p>

<h4>Module File</h4>

<p>Now were ready to create the <code>.module</code> file which will contain the code that will tap into the search api solr module. The search api solr search module already provides a hook that we can tap into to modify the search results. It&rsquo;s called the <code>search_api_solr_search_results_alter()</code>. This takes up 3 arguments, the first one is the <code>$results</code> which contains the current result set. As you can see its an argument that&rsquo;s passed by reference so we don&rsquo;t really have to return it. The second is the <code>$query</code>, we won&rsquo;t really use it in our custom module but its the variable that contains the current query. The third argument is the <code>$response</code>, this is the response object returned from Solr.</p>

<p>In the code below we first have to check whether we are in the specific view in which we want to execute our script.
In this case were checking if we are in the <code>q</code> view.
Next we declare a variable called <code>$locations</code>, this will store the modified version of the results returned from the Solr server.
Next we loop through the results and get the business name and the postal code.
We then use the postal code to query the Google Geocoding API.
After that, we simply convert the results returned from the Google Geocoding API to an array so we could extract
the coordinates (latitude and longitude). The coordinates is what we ultimately need in order to display the location of the businesses in a Google Map.
Finally we assign the modified data to the Drupal JavaScript object so that we could access it from the client-side.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * Implements hook_search_api_solr_search_results_alter().</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">function</span> <span class="nf">searchapisolrmod_search_api_solr_search_results_alter</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$results</span><span class="p">,</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$response</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;q&#39;</span><span class="p">){</span> <span class="c1">//only execute this script if we are in the q view</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$locations</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>  <span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$rest</span><span class="p">)){</span>    
</span><span class='line'>      <span class="k">foreach</span><span class="p">(</span><span class="nv">$rest</span> <span class="k">as</span> <span class="nv">$r</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>          <span class="nv">$place</span> <span class="o">=</span> <span class="nv">$r</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="s1">&#39;business_name&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//encode the postal code to be used as a query for the geocoding api</span>
</span><span class='line'>          <span class="nv">$postal_code</span> <span class="o">=</span>   <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$r</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="s1">&#39;business_address:postal_code&#39;</span><span class="p">]);</span>
</span><span class='line'>          
</span><span class='line'>          <span class="nv">$api</span> <span class="o">=</span> <span class="s1">&#39;http://maps.googleapis.com/maps/api/geocode/json?address=&#39;</span> <span class="o">.</span>  <span class="nv">$postal_code</span> <span class="o">.</span> <span class="s1">&#39;&amp;sensor=false&#39;</span><span class="p">;</span>
</span><span class='line'>          <span class="nv">$api_results</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$api</span><span class="p">);</span> <span class="c1">//get the results from the google geocoding api</span>
</span><span class='line'>          <span class="nv">$api_data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$api_results</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="nv">$api_data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span><span class="p">){</span>
</span><span class='line'>              <span class="nv">$location</span> <span class="o">=</span> <span class="nv">$api_data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>              <span class="nv">$locations</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>                  <span class="s1">&#39;place&#39;</span> <span class="o">=&gt;</span> <span class="nv">$place</span><span class="p">,</span>
</span><span class='line'>                  <span class="s1">&#39;lat&#39;</span> <span class="o">=&gt;</span> <span class="nv">$location</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span>
</span><span class='line'>                  <span class="s1">&#39;lng&#39;</span> <span class="o">=&gt;</span> <span class="nv">$location</span><span class="p">[</span><span class="s1">&#39;lng&#39;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">);</span>   
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>      <span class="s1">&#39;searchapisolrmod&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span> <span class="c1">//namespacing is very important</span>
</span><span class='line'>          <span class="s1">&#39;locations&#39;</span> <span class="o">=&gt;</span> <span class="nv">$locations</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;results&#39;</span> <span class="o">=&gt;</span> <span class="nv">$rest</span> <span class="c1">//store the original result set that was returned</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>  <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">drupal_add_js</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">&#39;setting&#39;</span><span class="p">);</span> <span class="c1">//add the data to the Drupal JavaScript object</span>
</span><span class='line'>  <span class="p">}</span>    
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h4>Accessing the data from the client-side</h4>

<p>The modified results is now available from the client side via the <code>Drupal</code> object.
You can make use of this data however you want.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Drupal.settings.searchapisolrmod.results</span>
</span><span class='line'><span class="x">Drupal.settings.searchapisolrmod.locations</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/13/getting-started-with-flickr-api/">Getting Started With Flickr API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-13T11:00:00+08:00" pubdate data-updated="true">Oct 13<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/13/getting-started-with-flickr-api/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this article I&rsquo;ll be showing you how to get started with using the Flickr API.
The Flickr API is a way to interact with data from Flickr Accounts.</p>

<h3>Getting an API Key</h3>

<p>First you have get an API Key from the <a href="http://www.flickr.com/services/apps/create/apply/">flickr developer website</a>.
In order to get an API key you first have to create an app.
The app is a way for flickr to track usage of their API. As you know, yahoo owns flickr so you first have to log in using your yahoo account in order to access the page for creating an app.</p>

<p>For the purpose of this tutorial you can just apply for a non-commercial key.</p>

<p><img src="/images/posts/getting_started_with_flickr_api/key_type.png" alt="key type" /></p>

<p>Next, enter an app info. It can be anything you want, but be sure to provide more detailed information if you will be using the API for a project that you&rsquo;re building:</p>

<p><img src="/images/posts/getting_started_with_flickr_api/app_info.png" alt="key type" /></p>

<p>Check the two checkboxes to agree with <a href="http://www.flickr.com/services/api/tos/">Flickr API terms of use</a>.
Be sure to read it so you will be informed of the limitations of the API.</p>

<p><img src="/images/posts/getting_started_with_flickr_api/app_key.png" alt="app key" /></p>

<p>Once you&rsquo;re done with that you can now see the Flickr key and Secret.
Copy those two as you will be needing it to interact with the API later.</p>

<h3>Interacting with the API</h3>

<p>Now were ready to actually interact with the API.
For this tutorial were going to create a little library that will interact with the flickr API for us and then we can simply include it in our code and call the methods from there.</p>

<p>Create a new php file and call it <code>class.flickr.php</code>. Declare 3 private variables which will store the flickr API key, the secret key and the format in which the results will be returned. In this case were using <code>json</code> so we can manipulate it with either JavaScript or PHP if we want. Under the constructor, simply assign the values for the <code>$flickr_key</code> and <code>$flickr_secret</code> to that of the arguments that will be passed later on when the <code>Flickr</code> class is instantiated.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Flickr</span><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="nv">$flickr_key</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="nv">$flickr_secret</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="nv">$format</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$flickr_key</span><span class="p">,</span> <span class="nv">$flickr_secret</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flickr_key</span> <span class="o">=</span> <span class="nv">$flickr_key</span><span class="p">;</span>
</span><span class='line'>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flickr_secret</span> <span class="o">=</span> <span class="nv">$flickr_secret</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h4>Searching of Public Photos</h4>

<p>Now let&rsquo;s create a method for searching of public photos on Flickr.
This method performs a call to the <code>flickr.photos.search</code> method from the API.
You can read more about the arguments which you can pass to that method <a href="http://www.flickr.com/services/api/flickr.photos.search.html">here</a>.</p>

<p>The <code>searchPhotos</code> method will take two arguments.
The first one is the query or the image that you&rsquo;re looking for. It can be the image title, description or tags that has been attached to it. Note that the query can be a single word or a collection of words, you can also prepend the minus sign (&ndash;) to a word if you want to exclude it in the search results.</p>

<p>The next argument is the tags, the tags is a comma-separated list of words that can be used to further describe the image that you&rsquo;re looking for.</p>

<p>As you can see from the method below were using the <code>urlencode()</code> method to wrap all the user input. This includes the query and the tags. We need to do this in order to properly format the request url.</p>

<p>Were also specifying a couple of arguments to the url aside from the <code>text</code> and the <code>tags</code>:</p>

<ul>
<li><p><strong>sort</strong> &ndash; the order in which to return the results, in this case I&rsquo;ve chosen <code>relevance</code> to be the value but it can also have a value of of <code>date-posted-asc</code>, <code>date-posted-desc</code>, <code>date-taken-asc</code>, <code>date-taken-desc</code>, <code>interestingness-desc</code>, and <code>interestingness-asc</code> all of which is self-explanatory.</p></li>
<li><p><strong>safe_search</strong> &ndash; the safe search argument is a filter for results that are returned. You will usually want this to have a value of <code>1</code> which tells to the API to only return results that are safe for viewing for all ages.</p></li>
<li><p><strong>content_type</strong> &ndash; the type of content, I&rsquo;ve selected the value of <code>4</code> for this to indicate that I want to return results that can be either photos or screenshots.</p></li>
<li><p><strong>api_key</strong> &ndash; the API key that we got earlier from creating the app.</p></li>
<li><p><strong>format</strong> &ndash; the format in which to return the results. In this case were using json.</p></li>
<li><p><strong>per_page</strong> &ndash; this is the limit of images to return per page. In this case we only want the API to return 10 images per page.</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">searchPhotos</span><span class="p">(</span><span class="nv">$query</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$tags</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$urlencoded_tags</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$tags</span><span class="p">)){</span>    
</span><span class='line'>      <span class="nv">$tags_r</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$tags</span><span class="p">);</span>
</span><span class='line'>      <span class="k">foreach</span><span class="p">(</span><span class="nv">$tags_r</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">){</span>
</span><span class='line'>          <span class="nv">$urlencoded_tags</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$tag</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>    
</span><span class='line'>
</span><span class='line'>  <span class="c1">//construct the url</span>
</span><span class='line'>  <span class="nv">$url</span>  <span class="o">=</span> <span class="s1">&#39;http://api.flickr.com/services/rest/?&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nv">$url</span> <span class="o">.=</span> <span class="s1">&#39;method=flickr.photos.search&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nv">$url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;text=&#39;</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
</span><span class='line'>  <span class="nv">$url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;tags=&#39;</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$urlencoded_tags</span><span class="p">);</span> <span class="c1">//convert the array of url encoded tags back to a string</span>
</span><span class='line'>  <span class="nv">$url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;sort=relevance&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nv">$url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;safe_search=1&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nv">$url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;content_type=4&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nv">$url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;api_key=&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flickr_key</span><span class="p">;</span>
</span><span class='line'>  <span class="nv">$url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;format=&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">;</span>
</span><span class='line'>  <span class="nv">$url</span> <span class="o">.=</span> <span class="s1">&#39;&amp;per_page=10&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//get the results</span>
</span><span class='line'>  <span class="nv">$result</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//remove the unneccessary strings that wraps the result returned from the API</span>
</span><span class='line'>  <span class="nv">$json</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="s2">&quot;jsonFlickrApi(&quot;</span><span class="p">),</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="o">-</span> <span class="nb">strlen</span><span class="p">(</span><span class="s2">&quot;jsonFlickrApi(&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$photos</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>  <span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//check if the status didn&#39;t fail</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;stat&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;fail&#39;</span><span class="p">){</span>
</span><span class='line'>      <span class="c1">//return only the data for the photos as that&#39;s the only thing that we need</span>
</span><span class='line'>      <span class="nv">$photos</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;photos&#39;</span><span class="p">][</span><span class="s1">&#39;photo&#39;</span><span class="p">];</span>
</span><span class='line'>      <span class="k">return</span> <span class="nv">$photos</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>After constructing the url we simply use the <code>file_get_contents()</code> method to request the data from the API.
The results will then be stored to the <code>$result</code> variable. But the API has wrapped up the data with a function named <code>jsonFlickrApi()</code> as you can see from the screenshot below:</p>

<p><img src="/images/posts/getting_started_with_flickr_api/flickr_results.png" alt="flickr results" /></p>

<p>Thus we cannot immediately convert it to a PHP array or even parse it with a json parser. So we need to use the <code>str_replace()</code> function to trim the unneccessary characters. And that&rsquo;s exactly what this particular line does:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$json</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="s2">&quot;jsonFlickrApi(&quot;</span><span class="p">),</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="o">-</span> <span class="nb">strlen</span><span class="p">(</span><span class="s2">&quot;jsonFlickrApi(&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we simply use the <code>json_decode()</code> function to convert the json string to an array.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$photos</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'><span class="nv">$data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//check if the status didn&#39;t fail</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;stat&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;fail&#39;</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//return only the data for the photos as that&#39;s the only thing that we need</span>
</span><span class='line'>  <span class="nv">$photos</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;photos&#39;</span><span class="p">][</span><span class="s1">&#39;photo&#39;</span><span class="p">];</span>
</span><span class='line'>  <span class="k">return</span> <span class="nv">$photos</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>But wait, were not really done yet. If you might have noticed from the screenshot of the results returned from the API earlier you might have noticed that there were no links to the images matching the query. The common purpose of using the flickr API is to fetch the image source of the images on the flickr website. So why are there no image sources as we can see from the parsed version of the results returned from the API below:</p>

<p><img src="/images/posts/getting_started_with_flickr_api/jsonview.png" alt="json parse" /></p>

<p>That&rsquo;s because we need to construct the url&rsquo;s ourselves using the data that has been returned from the API.
All you have to do is to extract the <code>farm</code>, <code>server</code>, <code>id</code> and the <code>secret</code>. Here&rsquo;s how to construct the url:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$src</span> <span class="o">=</span> <span class="s2">&quot;http://farm&quot;</span> <span class="o">.</span> <span class="nv">$photo</span><span class="p">[</span><span class="s1">&#39;farm&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;.static.flickr.com/&quot;</span> <span class="o">.</span> <span class="nv">$photo</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$photo</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;_&#39;</span> <span class="o">.</span> <span class="nv">$photo</span><span class="p">[</span><span class="s1">&#39;secret&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;_m.jpg&#39;</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>To call the method, you simply have to loop through the results returned from the <code>searchPhotos()</code> method and then construct the url from inside the loop:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">require_once</span><span class="p">(</span><span class="s1">&#39;class.flickr.php&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$flickr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Flickr</span><span class="p">(</span><span class="nv">$api_key</span><span class="p">,</span> <span class="nv">$api_secret</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$results</span> <span class="o">=</span> <span class="nv">$flickr</span><span class="o">-&gt;</span><span class="na">searchPhotos</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$tags</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$results</span><span class="p">)){</span>
</span><span class='line'>  <span class="k">foreach</span><span class="p">(</span><span class="nv">$results</span> <span class="k">as</span> <span class="nv">$photo</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$src</span> <span class="o">=</span> <span class="s2">&quot;http://farm&quot;</span> <span class="o">.</span> <span class="nv">$photo</span><span class="p">[</span><span class="s1">&#39;farm&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;.static.flickr.com/&quot;</span> <span class="o">.</span> <span class="nv">$photo</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$photo</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;_&#39;</span> <span class="o">.</span> <span class="nv">$photo</span><span class="p">[</span><span class="s1">&#39;secret&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;_m.jpg&#39;</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;img src=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$src</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">&quot; alt=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$photo</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="x">&quot;&gt;</span>
</span><span class='line'><span class="cp">&lt;?php</span>      
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h3>Conclusion</h3>

<p>The flickr API is a great way to fetch and modify user data from the flickr website.
We&rsquo;ve barely scratch the surface with this tutorial. If you want to learn more about the flickr API be sure to checko out the resources below.</p>

<h3>Resources</h3>

<ul>
<li><a href="http://www.flickr.com/services/developer/">Flickr Developer Guide</a></li>
<li><a href="http://www.flickr.com/services/api/">Flickr API Methods</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/26/getting-started-with-caching-in-php/">Getting Started with Caching in PHP</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/08/getting-started-with-paypal-api/">Getting Started with Paypal API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/15/php-security-best-practices/">PHP Security Best Practices</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/01/getting-started-with-bitpay-api/">Getting Started with Bitpay API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/09/getting-started-with-shopify-app-development/">Getting Started with Shopify App Development</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/anchetawern">@anchetawern</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'anchetawern',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/wernancheta?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/wernancheta">My Delicious Bookmarks &raquo;</a></p>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/104518132178203766400?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Wern Ancheta -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'wernancheta';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




<script src="/javascripts/csshttprequest.min.js"></script>
<script>
if($('.entry-title').length == 1){
	var entry_title = $('.entry-title').text();
	CSSHttpRequest.get(
	    "http://phpdev-wern.rhcloud.com/crossdomain/counter.php?title=" + entry_title,
	    function(response){
	  		console.log('updated');  	
	    }
	);
}
</script>
</body>
</html>
